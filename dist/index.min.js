(()=>{"use strict";var e={375:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Union=t.Undefined=t.Tuple=t.StringLiteral=t.String=t.Reference=t.Record=t.Object=t.NumberLiteral=t.Number=t.Null=t.Intersection=t.BooleanLiteral=t.Boolean=t.Array=t.Any=void 0,t.Any={as:(e,t="")=>e,is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Array={of:e=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Array){for(let s=0;s<t.length;s++)e.as(t[s],r+"["+s+"]");return t}throw"Expected an array at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Boolean={as(e,t=""){if(null!=e&&e.constructor===globalThis.Boolean)return e;throw"Expected a boolean at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.BooleanLiteral={of:e=>({as(t,r=""){if(t===e)return t;throw"Expected "+e+" at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Intersection={of:(...e)=>({as(t,r=""){for(let s of e)s.as(t,r);return t},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Null={as(e,t=""){if(null===e)return e;throw"Expected null at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Number={as(e,t=""){if(null!=e&&e.constructor===globalThis.Number)return e;throw"Expected a number at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.NumberLiteral={of:e=>({as(t,r=""){if(t===e)return t;throw"Expected "+e+" at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Object={of:e=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Object){for(let s in e)e[s].as(t[s],r+/^([a-z][a-z0-9_]*)$/is.test(s)?"."+s:'["'+s+'"]');return t}throw"Expected an object at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Record={of:e=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Object){for(let s of globalThis.Object.keys(t))e.as(t[s],r+'["'+s+'"]');return t}throw"Expected a record at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Reference={of:e=>({as:(t,r="")=>e().as(t,r),is:t=>e().is(t)})},t.String={as(e,t=""){if(null!=e&&e.constructor===globalThis.String)return e;throw"Expected a string at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.StringLiteral={of:e=>({as(t,r=""){if(t===e)return t;throw'Expected "'+e+'" at '+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Tuple={of:(...e)=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Array){for(let s=0;s<e.length;s++)e[s].as(t[s],r+"["+s+"]");return t}throw"Expected a tuple at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Undefined={as(e,t=""){if(void 0===e)return e;throw"Expected undefined at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Union={of:(...e)=>({as(t,r=""){for(let s of e)try{return s.as(t,r)}catch(e){}throw"Expected a union at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})}},175:(e,t,r)=>{t.l8=void 0;const s=r(375);t.l8=s;r(226);r(129);r(329)},226:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Schema=t.UnionType=t.UndefinedType=t.TupleType=t.StringLiteralType=t.StringType=t.ReferenceType=t.RecordType=t.ObjectType=t.NumberLiteralType=t.NumberType=t.NullType=t.IntersectionType=t.GroupType=t.BooleanLiteralType=t.BooleanType=t.ArrayType=t.AnyType=t.Type=void 0;const s=r(329);t.Type={parse(e,...t){try{return w.parse(e,...t)}catch(e){}try{return u.parse(e,...t)}catch(e){}try{return i.parse(e,...t)}catch(e){}try{return n.parse(e)}catch(e){}try{return a.parse(e)}catch(e){}try{return l.parse(e)}catch(e){}try{return c.parse(e)}catch(e){}try{return p.parse(e)}catch(e){}try{return h.parse(e)}catch(e){}try{return g.parse(e)}catch(e){}try{return b.parse(e)}catch(e){}try{return _.parse(e)}catch(e){}try{return y.parse(e)}catch(e){}try{return m.parse(e)}catch(e){}try{return d.parse(e)}catch(e){}try{return o.parse(e)}catch(e){}try{return f.parse(e)}catch(e){}return e.newContext(((e,t)=>{let r=e();throw`Unexpected ${r.family} at row ${r.row}, col ${r.col}!`}))}};class n{constructor(){}generateType(e){return"any"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\treturn subject;"),t.push("}")):t.push("autoguard.Any"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(s.expect(e(),"any"),n.INSTANCE)))}}t.AnyType=n,n.INSTANCE=new n;class i{constructor(e){this.type=e}generateType(e){return this.type.generateType(e)+"[]"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Array)) {"),t.push("\t\tfor (let i = 0; i < subject.length; i++) {"),t.push("\t\t\t("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t\t"}))+')(subject[i], path + "[" + i + "]");'),t.push("\t\t}"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected an array at " + path + "!";'),t.push("}")):t.push("autoguard.Array.of("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}static parse(e,...r){if(r.includes("Array"))throw"Recursion prevention!";return e.newContext(((n,a)=>{let l=t.Type.parse(e,...r,"Array");s.expect(n(),"["),s.expect(n(),"]");let o=new i(l);for(;;)try{e.newContext(((e,t)=>{s.expect(e(),"["),s.expect(e(),"]"),o=new i(o)}))}catch(e){break}return o}))}}t.ArrayType=i;class a{constructor(){}generateType(e){return"boolean"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Boolean)) {"),t.push("\t\treturn subject as boolean;"),t.push("\t}"),t.push('\tthrow "Expected a boolean at " + path + "!";'),t.push("}")):t.push("autoguard.Boolean"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(s.expect(e(),"boolean"),a.INSTANCE)))}}t.BooleanType=a,a.INSTANCE=new a;class l{constructor(e){this.value=e}generateType(e){return""+this.value}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected '+this.value+' at " + path + "!";'),t.push("}")):t.push("autoguard.BooleanLiteral.of("+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>"true"===s.expect(e(),["true","false"]).family?l.INSTANCE_TRUE:l.INSTANCE_FALSE))}}t.BooleanLiteralType=l,l.INSTANCE_TRUE=new l(!0),l.INSTANCE_FALSE=new l(!1);class o{constructor(e){this.type=e}generateType(e){return"("+this.type.generateType(e)+")"}generateTypeGuard(e){return this.type.generateTypeGuard(e)}static parse(e){return e.newContext(((r,n)=>{s.expect(r(),"(");let i=t.Type.parse(e);return s.expect(r(),")"),new o(i)}))}}t.GroupType=o;class u{constructor(){this.types=new Set}add(e){return this.types.add(e),this}generateType(e){let t=new Array;for(let r of this.types)t.push(r.generateType(e));return t.join(" & ")}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {");for(let r of this.types)t.push("\t("+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+")(subject, path);");return t.push("\treturn subject;"),t.push("}"),t.join(e.eol)}for(let r of this.types)t.push("\t"+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Intersection.of("+e.eol+t.join(","+e.eol)+e.eol+")"}static parse(e,...r){if(r.includes("Intersection"))throw"Recursion prevention!";return e.newContext(((n,i)=>{var a;let l=t.Type.parse(e,...r,"Intersection"),o=new u;for(o.add(l);"&"===(null===(a=i())||void 0===a?void 0:a.value);){s.expect(n(),"&");let i=t.Type.parse(e,...r,"Intersection");o.add(i)}return 1===o.types.size?l:o}))}}t.IntersectionType=u;class c{constructor(){}generateType(e){return"null"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === null) {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected null at " + path + "!";'),t.push("}")):t.push("autoguard.Null"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(s.expect(e(),"null"),c.INSTANCE)))}}t.NullType=c,c.INSTANCE=new c;class p{constructor(){}generateType(e){return"number"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Number)) {"),t.push("\t\treturn subject as number;"),t.push("\t}"),t.push('\tthrow "Expected a number at " + path + "!";'),t.push("}")):t.push("autoguard.Number"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(s.expect(e(),"number"),p.INSTANCE)))}}t.NumberType=p,p.INSTANCE=new p;class h{constructor(e){this.value=e}generateType(e){return""+this.value}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected '+this.value+' at " + path + "!";'),t.push("}")):t.push("autoguard.NumberLiteral.of("+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>{let r=s.expect(e(),"NUMBER_LITERAL").value;return new h(Number.parseInt(r))}))}}t.NumberLiteralType=h;class d{constructor(){this.members=new Map}add(e,t){return this.members.set(e,t),this}generateType(e){if(0===this.members.size)return"{}";let t=new Array;for(let[r,s]of this.members)t.push('\t"'+r+'"'+(s.optional?"?":"")+": "+s.type.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"{"+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"}"}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Object)) {");for(let[r,s]of this.members){let n=s.type;if(s.optional){let e=new w;e.add(_.INSTANCE),e.add(n),n=e}let i=/^([a-z][a-z0-9_]*)$/is.test(r)?'".'+r+'"':'"[\\"'+r+'\\"]"';t.push("\t\t("+n.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+')(subject["'+r+'"], path + '+i+");")}return t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected an object at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let[r,s]of this.members){let n=s.type;if(s.optional){let e=new w;e.add(_.INSTANCE),e.add(n),n=e}t.push('\t"'+r+'": '+n.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})))}return"autoguard.Object.of<"+(null!=this.typename?this.typename:this.generateType(e))+">({"+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"})"}setTypename(e){this.typename=e}static parse(e){return e.newContext(((r,n)=>{var i,a,l;s.expect(r(),"{");let o=new d;if("}"!==(null===(i=n())||void 0===i?void 0:i.value))for(;;){let i=!1,u=s.expect(r(),["any","boolean","false","null","number","string","true","undefined","IDENTIFIER","STRING_LITERAL"]),c="STRING_LITERAL"===u.family?u.value.slice(1,-1):u.value;"?"===(null===(a=n())||void 0===a?void 0:a.value)&&(r(),i=!0),s.expect(r(),":");let p=t.Type.parse(e);if(o.add(c,{type:p,optional:i}),","!==(null===(l=n())||void 0===l?void 0:l.value))break;s.expect(r(),",")}return s.expect(r(),"}"),o}))}}t.ObjectType=d;class f{constructor(e){this.type=e}generateType(e){return"Record<string, undefined | "+this.type.generateType(e)+">"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Object)) {"),t.push("\t\tfor (let key of globalThis.Object.keys(subject)) {"),t.push("\t\t\t("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t\t"}))+')(subject[key], path + "[\\"" + key + "\\"]");'),t.push("\t\t}"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected a record at " + path + "!";'),t.push("}")):t.push("autoguard.Record.of("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}static parse(e){return e.newContext(((r,n)=>{s.expect(r(),"{");let i=t.Type.parse(e);return s.expect(r(),"}"),new f(i)}))}}t.RecordType=f;class y{constructor(e){this.typename=e}generateType(e){return this.typename}generateTypeGuard(e){return e.standalone?this.typename+".as":"autoguard.Reference.of<"+this.typename+">(() => "+this.typename+")"}static parse(e){return e.newContext(((e,t)=>{var r;"@"===(null===(r=t())||void 0===r?void 0:r.family)&&s.expect(e(),"@");let n=s.expect(e(),"IDENTIFIER").value;return new y(n)}))}}t.ReferenceType=y;class g{constructor(){}generateType(e){return"string"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.String)) {"),t.push("\t\treturn subject as string;"),t.push("\t}"),t.push('\tthrow "Expected a string at " + path + "!";'),t.push("}")):t.push("autoguard.String"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(s.expect(e(),"string"),g.INSTANCE)))}}t.StringType=g,g.INSTANCE=new g;class b{constructor(e){this.value=e}generateType(e){return'"'+this.value+'"'}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected \\"'+this.value+'\\" at " + path + "!";'),t.push("}")):t.push('autoguard.StringLiteral.of("'+this.value+'")'),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>{let r=s.expect(e(),"STRING_LITERAL").value;return new b(r.slice(1,-1))}))}}t.StringLiteralType=b;class m{constructor(){this.types=new Array}add(e){return this.types.push(e),this}generateType(e){let t=new Array;for(let r of this.types)t.push("\t"+r.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"["+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"]"}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Array)) {");for(let r=0;r<this.types.length;r++){let s=this.types[r];t.push("\t\t("+s.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject["+r+'], path + "['+r+']");')}return t.push("\t\treturn subject as "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+";"),t.push("\t}"),t.push('\tthrow "Expected a tuple at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let r of this.types)t.push("\t"+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Tuple.of("+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+")"}static parse(e){return e.newContext(((r,n)=>{var i,a;s.expect(r(),"[");let l=new m;if("]"!==(null===(i=n())||void 0===i?void 0:i.value))for(;;){let i=t.Type.parse(e);if(l.add(i),","!==(null===(a=n())||void 0===a?void 0:a.value))break;s.expect(r(),",")}return s.expect(r(),"]"),l}))}}t.TupleType=m;class _{constructor(){}generateType(e){return"undefined"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === undefined) {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected undefined at " + path + "!";'),t.push("}")):t.push("autoguard.Undefined"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(s.expect(e(),"undefined"),_.INSTANCE)))}}t.UndefinedType=_,_.INSTANCE=new _;class w{constructor(){this.types=new Set}add(e){return this.types.add(e),this}generateType(e){let t=new Array;for(let r of this.types)t.push(r.generateType(e));return t.join(" | ")}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {");for(let r of this.types)t.push("\ttry {"),t.push("\t\treturn ("+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject, path);"),t.push("\t} catch (error) {}");return t.push('\tthrow "Expected a union at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let r of this.types)t.push("\t"+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Union.of("+e.eol+t.join(","+e.eol)+e.eol+")"}static parse(e,...r){if(r.includes("Union"))throw"Recursion prevention!";return e.newContext(((n,i)=>{var a;let l=t.Type.parse(e,...r,"Union"),o=new w;for(o.add(l);"|"===(null===(a=i())||void 0===a?void 0:a.value);){s.expect(n(),"|");let i=t.Type.parse(e,...r,"Union");o.add(i)}return 1===o.types.size?l:o}))}}t.UnionType=w;class T{constructor(){this.types=new Map}add(e,t){return this.types.set(e,t),this}generateModule(e){let t=new Array;t.push("// This file was auto-generated by @joelek/ts-autoguard. Edit at own risk."),t.push(""),e.standalone||(t.push('import { guards as autoguard } from "@joelek/ts-autoguard";'),t.push(""));for(let[r,s]of this.types)t.push("export type "+r+" = "+s.generateType(e)+";"),t.push(""),e.standalone?(t.push("export const "+r+" = {"),t.push('\tas(subject: any, path: string = ""): '+r+" {"),t.push("\t\treturn ("+s.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject, path);"),t.push("\t},"),t.push("\tis(subject: any): subject is "+r+" {"),t.push("\t\ttry {"),t.push("\t\t\tthis.as(subject);"),t.push("\t\t} catch (error) {"),t.push("\t\t\treturn false;"),t.push("\t\t}"),t.push("\t\treturn true;"),t.push("\t}"),t.push("};"),t.push("")):(t.push("export const "+r+" = "+s.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+";"),t.push(""));let r=new d;for(let[e,t]of this.types)r.add(e,{type:new y(e),optional:!1});return t.push("export type Autoguard = "+r.generateType(e)+";"),t.push(""),t.push("export const Autoguard = "+r.generateType(e)+";"),t.push(""),t.join(e.eol)}static parse(e){return e.newContext(((r,n)=>{var i,a,l;s.expect(r(),"{");let o=new T;if("}"!==(null===(i=n())||void 0===i?void 0:i.value))for(;;){let i=s.expect(r(),"IDENTIFIER").value;s.expect(r(),":");let u=t.Type.parse(e);if(null===(a=u.setTypename)||void 0===a||a.call(u,i),o.add(i,u),","!==(null===(l=n())||void 0===l?void 0:l.value))break;s.expect(r(),",")}if(s.expect(r(),"}"),null!=n())throw"Expected end of stream!";return o}))}}t.Schema=T},129:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MessageSerializer=void 0,t.MessageSerializer=class{constructor(e){this.guards=e}deserialize(e,t){let r=JSON.parse(e);if(null==r||r.constructor!==Object||null==r.type||r.type.constructor!==String)throw"Invalid message envelope!";{let e=r.type,s=r.data,n=this.guards[e];if(void 0===n)throw'Unknown message type "'+e+'"!';t(e,n.as(s))}}serialize(e,t){return JSON.stringify({type:e,data:t})}}},329:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.expect=t.Tokenizer=t.Families=void 0,t.Families=["WS","(",")","[","]","{","}","?","|","&","@",",",":","any","boolean","false","null","number","string","true","undefined","IDENTIFIER","NUMBER_LITERAL","STRING_LITERAL"],t.Tokenizer=class{constructor(e){let t={WS:/^([\t\r\n ]+)/ius,"(":/^([\(])/ius,")":/^([\)])/ius,"[":/^([\[])/ius,"]":/^([\]])/ius,"{":/^([\{])/ius,"}":/^([\}])/ius,"?":/^([\?])/ius,"|":/^([\|])/ius,"&":/^([&])/ius,"@":/^([@])/ius,",":/^([,])/ius,":":/^([:])/ius,any:/^(any)/ius,boolean:/^(boolean)/ius,false:/^(false)/ius,null:/^(null)/ius,number:/^(number)/ius,string:/^(string)/ius,true:/^(true)/ius,undefined:/^(undefined)/ius,IDENTIFIER:/^([a-z][a-z0-9_]*)/ius,NUMBER_LITERAL:/^(([1-9][0-9]+)|([0-9]))/ius,STRING_LITERAL:/^(["][^"]*["])/ius},r=new Array,s=1,n=1;for(;e.length>0;){let i;for(let r in t){let s=r,n=t[s].exec(e);null!=n&&(null==i||n[1].length>i[1].length)&&(i=[s,n[1]])}if(null==i)throw`Unrecognized token at row ${s}, col ${n}!`;r.push({family:i[0],value:i[1],row:s,col:n}),e=e.slice(i[1].length);let a=i[1].split(/\r?\n/);a.length>1&&(s+=a.length-1,n=1),n+=a[a.length-1].length}this.tokens=r.filter((e=>"WS"!==e.family)),this.offset=0}peek(){return this.tokens[this.offset]}read(){if(this.offset>=this.tokens.length)throw"Unexpectedly reached end of stream!";return this.tokens[this.offset++]}newContext(e){let t=this.offset;try{return e((()=>this.read()),(()=>this.peek()))}catch(e){throw this.offset=t,e}}},t.expect=function(e,t){if(!(Array.isArray(t)?t:[t]).includes(e.family))throw`Unexpected ${e.family} at row ${e.row}, col ${e.col}!`;return e}}},t={};function r(s){if(t[s])return t[s].exports;var n=t[s]={exports:{}};return e[s](n,n.exports,r),n.exports}(()=>{const e=require("crypto"),t=require("fs"),s=require("path");function n(e){return null!=e&&e.constructor===String}class i{constructor(e){this.string=e,this.offset=0,this.length=e.length}done(){return this.offset===this.length}line(){let e="";for(;!this.done();){let t=this.string[this.offset];if(this.offset+=1,"\r"===t){this.done()||"\n"===this.string[this.offset]&&(this.offset+=1);break}if("\n"===t){this.done()||"\r"===this.string[this.offset]&&(this.offset+=1);break}e+=t}return e}keep(e){let t="";for(;!(this.done()||e.indexOf(this.peek(1))>=0);)t+=this.read(1);return t}peek(e){let t=n(e)?e.length:e,r=Math.min(this.offset,this.offset+t),s=Math.max(this.offset,this.offset+t);if(r<0||r>=this.length||s<0||s>this.length)throw"Unable to read between offsets "+r+" and "+s+" because length is "+this.length+"!";let i=this.string.substring(r,s);if(n(e)&&i!==e)throw'Expected "'+e+'" but read "'+i+'"!';return i}read(e){let t=this.peek(e);return this.offset+=t.length,t}seek(e){if(e<0||e>=this.length)throw"Unable to seek to offset "+e+" because length is "+this.length+"!";this.offset=e}skip(e){let t="";for(;!(this.done()||e.indexOf(this.peek(1))<0);)t+=this.read(1);return t}tell(){return this.offset}}function a(e,t){let r=e.read(t.length);if(r!==t)throw'Expected "'+t+'" but read "'+r+'"!'}function l(e){let t=e.line();if(""!==t)throw'Expected a blank line but read "'+t+'"!'}function o(e){let t=null;return null!=(t=/^([0-9][0-9])[:]([0-5][0-9])[:]([0-5][0-9])[.]([0-9][0-9][0-9])$/.exec(e.peek(12)))?(e.read(12),1e3*(60*(60*parseInt(t[1],10)+parseInt(t[2],10))+parseInt(t[3],10))+parseInt(t[4],10)):null!=(t=/^([0-5][0-9])[:]([0-5][0-9])[.]([0-9][0-9][0-9])$/.exec(e.peek(9)))?(e.read(9),1e3*(60*(0+parseInt(t[1],10))+parseInt(t[2],10))+parseInt(t[3],10)):(console.log("Expected a valid timecode!"),0)}function u(e){let t=o(e);a(e," --\x3e ");let r=o(e);l(e);let s=r-t;s<0&&console.log("Expected a positive duration but read "+t+" and "+r+"!");let n=new Array;for(;;){let t=e.line();if(""===t)break;n.push(t)}return{start_ms:t,duration_ms:s,lines:n}}var c=r(175);const p=c.l8.Object.of({type:c.l8.StringLiteral.of("episode"),imdb:c.l8.String,title:c.l8.String,year:c.l8.Number,summary:c.l8.String,show:c.l8.Object.of({imdb:c.l8.String,title:c.l8.String,genres:c.l8.Array.of(c.l8.String)}),season:c.l8.Number,episode:c.l8.Number}),h=c.l8.Object.of({type:c.l8.StringLiteral.of("movie"),imdb:c.l8.String,title:c.l8.String,year:c.l8.Number,summary:c.l8.String,genres:c.l8.Array.of(c.l8.String)}),d={eng:{title:"English",iso639_1:"en",iso3166_1:"US"},swe:{title:"Swedish",iso639_1:"sv",iso3166_1:"SE"},jpn:{title:"Japanese",iso639_1:"ja",iso3166_1:"JP"}};let f="./private/media/";t.existsSync(f)||t.mkdirSync(f,{recursive:!0});let y={audio:{artists:new Array,albums:new Array,discs:new Array,tracks:new Array,album_artists:new Array,track_artists:new Array},video:{genres:new Array,movie_parts:new Array,movies:new Array,movie_genres:new Array,shows:new Array,show_genres:new Array,seasons:new Array,episodes:new Array,subtitles:new Array,subtitle_contents:new Array,cues:new Array},files:new Array},g={},b={},m={},_={},w={},T={},j={},v={},S={},x={},A={},k={},E={},N={},I={},O={},C=e=>{e.video_genre_id in g||(g[e.video_genre_id]=e,y.video.genres.push(e))},R=e=>{let t=Array.of(e.show_id,e.video_genre_id).join(":");t in b||(b[t]=e,y.video.show_genres.push(e))},G=e=>{let t=Array.of(e.movie_id,e.video_genre_id).join(":");t in m||(m[t]=e,y.video.movie_genres.push(e))},L=e=>{e.artist_id in x||(x[e.artist_id]=e,y.audio.artists.push(e))},B=e=>{e.album_id in A||(A[e.album_id]=e,y.audio.albums.push(e))},U=e=>{e.disc_id in k||(k[e.disc_id]=e,y.audio.discs.push(e))},$=e=>{e.track_id in E||(E[e.track_id]=e,y.audio.tracks.push(e))},z=e=>{let t=Array.of(e.album_id,e.artist_id).join(":");t in N||(N[t]=e,y.audio.album_artists.push(e))},F=e=>{let t=Array.of(e.track_id,e.artist_id).join(":");t in I||(I[t]=e,y.audio.track_artists.push(e))},M=e=>{e.file_id in O||(O[e.file_id]=e,y.files.push(e))},D=e=>(127&e[0])<<21|(127&e[1])<<14|(127&e[2])<<7|(127&e[3])<<0;function J(e){return e.toLowerCase().normalize("NFKD").replace(/[\|\/\\\_\-]/g," ").replace(/[^a-z0-9 ]/g,"").trim().split(/[ ]+/g)}function P(...t){const r=t.map(J).map((e=>e.join(" "))).join(":"),s=e.createHash("md5");return s.update(r),s.digest("hex")}function W(e,t){return e.toString().padStart(t,"0")}let X=e=>256*e[0]*256*256+(e[1]<<16|e[2]<<8|e[3]<<0),q=e=>{let r=Buffer.alloc(8);e.offset+=t.readSync(e.fd,r,0,r.length,e.offset);let s=X(r.slice(0,4));return{kind:r.slice(4,8).toString("binary"),length:s}},K=(e,r)=>{let s=Buffer.alloc(r.length-8);return e.offset+=t.readSync(e.fd,s,0,s.length,e.offset),s},V=(e,t,r,s)=>{let n=0;for(;n<s;){let s=q(t);if(0===s.length)break;if(n+=s.length,""===r&&"moov"===s.kind)V(e,t,`${r}.${s.kind}`,s.length);else if(".moov"===r&&"udta"===s.kind)V(e,t,`${r}.${s.kind}`,s.length);else if(".moov.udta"===r&&"meta"===s.kind)t.offset+=4,V(e,t,`${r}.${s.kind}`,s.length);else if(".moov.udta.meta"===r&&"ilst"===s.kind)V(e,t,`${r}.${s.kind}`,s.length);else if(".moov"===r&&"mvhd"===s.kind){let r=K(t,s),n=12,i=r.readUInt32BE(n);n+=4;let a=r.readUInt32BE(n);n+=4,e.duration=a/i*1e3|0}else if(".moov.udta.meta.ilst"===r)if("tvsh"===s.kind){let r=K(t,s);e.show=r.slice(16).toString()}else if("tven"===s.kind){let r=K(t,s);e.title=r.slice(16).toString()}else if("tves"===s.kind){let r=K(t,s);e.episode=X(r.slice(16))}else if("tvsn"===s.kind){let r=K(t,s);e.season=X(r.slice(16))}else if("©nam"===s.kind){let r=K(t,s);e.title=r.slice(16).toString()}else if("©day"===s.kind){let r=K(t,s);e.year=parseInt(r.slice(16).toString())}else if("©ART"===s.kind){let r=K(t,s);e.artists=r.slice(16).toString().split(";").map((e=>e.trim()))}else if("aART"===s.kind){let r=K(t,s);e.album_artists=r.slice(16).toString().split(";").map((e=>e.trim()))}else if("©alb"===s.kind){let r=K(t,s);e.album=r.slice(16).toString()}else if("trkn"===s.kind){let r=K(t,s);e.track_number=X(r.slice(16))}else if("disk"===s.kind){let r=K(t,s);e.disc_number=X(r.slice(16))}else if("©cmt"===s.kind){let r=K(t,s);e.comment=r.slice(16).toString()}else t.offset+=s.length-8;else t.offset+=s.length-8}},H=e=>{let r=t.statSync(e);if(r.isDirectory())t.readdirSync(e).map((t=>s.join(e,t))).map(H);else if(r.isFile()){try{return(e=>{let r=(e=>{let r=t.openSync(e,"r");try{let e=Buffer.alloc(10);if(t.readSync(r,e,0,e.length,null),"ID3\0"!==e.slice(0,5).toString())throw new Error;let s=D(e.slice(6,10)),n=Buffer.alloc(s);t.readSync(r,n,0,n.length,null);let i={track_title:null,album_name:null,year:null,track:null,tracks:null,disc:null,discs:null,track_artists:null,album_artists:null,duration:0},a=0;for(;a<n.length;){let e=n.slice(a,a+4).toString(),t=D(n.slice(a+4,a+4+4)),r=(n.slice(a+8,a+8+2),n.slice(a+10,a+10+t));if(a+=10+t,"\0\0\0\0"===e)break;if("TIT2"===e)i.track_title=r.slice(1,-1).toString();else if("TALB"===e)i.album_name=r.slice(1,-1).toString();else if("TDRC"===e){let e=r.slice(1,-1).toString(),t=/^([0-9]{4})$/.exec(e);null!==t&&(i.year=parseInt(t[1]))}else if("TRCK"===e){let e=r.slice(1,-1).toString(),t=/^([0-9]{2})\/([0-9]{2})$/.exec(e);null!==t&&(i.track=parseInt(t[1]),i.tracks=parseInt(t[2]))}else if("TPOS"===e){let e=r.slice(1,-1).toString(),t=/^([0-9]{2})\/([0-9]{2})$/.exec(e);null!==t&&(i.disc=parseInt(t[1]),i.discs=parseInt(t[2]))}else if("TPE1"===e)i.track_artists=r.slice(1,-1).toString().split(";").map((e=>e.trim()));else if("TPE2"===e)i.album_artists=r.slice(1,-1).toString().split(";").map((e=>e.trim()));else if("TXXX"===e){let e=r.slice(1,-1).toString(),t=/^ALBUM ARTIST\0(.+)$/.exec(e);null!==t&&(i.album_artists=t[1].split(";").map((e=>e.trim())))}}let l=Buffer.alloc(4);t.readSync(r,l,0,l.length,null);let o=(255&l[0])<<3|(224&l[1])>>5,u=(24&l[1])>>3,c=(6&l[1])>>1,p=(l[1],(240&l[2])>>4),h=(12&l[2])>>2,d=(2&l[2])>>1;if(l[2],l[3],l[3],l[3],l[3],l[3],2047===o&&3===u&&1===c){let e=1152;if(9===p&&0===h){let s=128e3*e/8/44100|0;d&&s++;let n=1*s,l=Buffer.alloc(n-4);if(t.readSync(r,l,0,l.length,null),l.slice(0,32),"Xing"===l.slice(32,36).toString("binary")){let e=l.slice(36,40),t=(8&e[3])>>3,r=(4&e[3])>>2,s=(2&e[3])>>1,n=(1&e[3])>>0;if(a=40,n){let e=l.readUInt32BE(a);a+=4,i.duration=1152*e/44100*1e3|0}s&&(l.readUInt32BE(a),a+=4),r&&(a+=100),t&&(l.readUInt32BE(a),a+=4)}}}return t.closeSync(r),i}catch(e){throw t.closeSync(r),e}})(e),n=e.split(s.sep),i=P(...n);if(M({file_id:i,path:n,mime:"audio/mp3"}),null!==r.album_artists&&null!==r.album_name&&null!==r.year&&null!==r.disc&&null!==r.track&&null!=r.track_artists&&null!==r.track_title){let e=P(...r.album_artists,r.album_name,W(r.year,4));B({album_id:e,title:r.album_name,year:r.year,cover_file_id:null});for(let t of r.album_artists){let r=P(t);L({artist_id:r,title:t}),z({album_id:e,artist_id:r})}let t=P(...r.album_artists,r.album_name,W(r.year,4),W(r.disc,2));U({disc_id:t,album_id:e,number:r.disc});let s=P(...r.album_artists,r.album_name,W(r.year,4),W(r.disc,2),W(r.track,2));$({track_id:s,disc_id:t,file_id:i,title:r.track_title,number:r.track,duration:r.duration});for(let e of r.track_artists){let t=P(e);L({artist_id:t,title:e}),F({track_id:s,artist_id:t})}}})(e)}catch(e){}try{return(e=>{let r=(e=>{let r={fd:t.openSync(e,"r"),offset:0};try{let e=q(r);if("ftyp"!==e.kind)throw new Error;K(r,e);let s={show:null,season:null,episode:null,title:null,year:null,duration:0,comment:null,artists:null,album_artists:null,album:null,track_number:null,disc_number:null};return V(s,r,"",e.length),t.closeSync(r.fd),s}catch(e){throw t.closeSync(r.fd),e}})(e),n=e.split(s.sep),i=P(...n);if(null!==r.show&&null!==r.season&&null!==r.episode&&null!==r.title){M({file_id:i,path:n,mime:"video/mp4"});let e=P(r.show),t=P(r.show,W(r.season,2)),s=P(r.show,W(r.season,2),W(r.episode,2));return(o={show_id:e,title:r.show}).show_id in T||(T[o.show_id]=o,y.video.shows.push(o)),(l={season_id:t,show_id:e,number:r.season}).season_id in j||(j[l.season_id]=l,y.video.seasons.push(l)),void((a={episode_id:s,season_id:t,file_id:i,title:r.title,number:r.episode,duration:r.duration,year:r.year,summary:r.comment}).episode_id in v||(v[a.episode_id]=a,y.video.episodes.push(a)))}var a,l,o;if(null==r.album_artists||null==r.album||null==r.year||null==r.disc_number||null==r.track_number||null==r.artists||null==r.title){if(null!==r.title&&null!==r.year){M({file_id:i,path:n,mime:"video/mp4"});let e=P(r.title,W(r.year,4)),t=r.track_number||1;return(c={movie_part_id:P(r.title,W(r.year,4),W(t,2)),movie_id:e,file_id:i,duration:r.duration,number:t}).movie_part_id in _||(_[c.movie_part_id]=c,y.video.movie_parts.push(c)),void((u={movie_id:e,title:r.title,year:r.year,poster_file_id:null,summary:r.comment}).movie_id in w||(w[u.movie_id]=u,y.video.movies.push(u)))}var u,c}else{M({file_id:i,path:n,mime:"audio/mp4"});let e=P(...r.album_artists,r.album,W(r.year,4));B({album_id:e,title:r.album,year:r.year,cover_file_id:null});for(let t of r.album_artists){let r=P(t);L({artist_id:r,title:t}),z({album_id:e,artist_id:r})}let t=P(...r.album_artists,r.album,W(r.year,4),W(r.disc_number,2));U({disc_id:t,album_id:e,number:r.disc_number});let s=P(...r.album_artists,r.album,W(r.year,4),W(r.disc_number,2),W(r.track_number,2));$({track_id:s,disc_id:t,file_id:i,title:r.title,number:r.track_number,duration:r.duration});for(let e of r.artists){let t=P(e);L({artist_id:t,title:e}),F({track_id:s,artist_id:t})}}})(e)}catch(e){}try{return(e=>{try{return(e=>{let r={fd:t.openSync(e,"r"),offset:0};try{let n=Buffer.alloc(1024);r.offset+=t.readSync(r.fd,n,0,n.length,r.offset);let i=n.toString("utf8").split("\r\n").reduce(((e,t)=>(e.push(...t.split("\n")),e)),new Array);if("WEBVTT"!==i[0].substr(0,6))throw new Error;i[0].substr(7);let a=e.split(s.sep),l=P(...a);M({file_id:l,path:a,mime:"text/vtt"}),t.closeSync(r.fd)}catch(e){throw t.closeSync(r.fd),e}})(e)}catch(e){}throw new Error})(e)}catch(e){}try{return(e=>{try{return(e=>{let r={fd:t.openSync(e,"r"),offset:0};try{let n=Buffer.alloc(8);if(r.offset+=t.readSync(r.fd,n,0,n.length,r.offset),"PNG\r\n\n"!==n.toString("binary"))throw new Error;let i=e.split(s.sep),a=P(...i);M({file_id:a,path:i,mime:"image/png"}),t.closeSync(r.fd)}catch(e){throw t.closeSync(r.fd),e}})(e)}catch(e){}try{return(e=>{let r={fd:t.openSync(e,"r"),offset:0};try{let n=Buffer.alloc(10);if(r.offset+=t.readSync(r.fd,n,0,n.length,r.offset),"ÿØÿà\0JFIF"!==n.toString("binary"))throw new Error;let i=e.split(s.sep),a=P(...i);M({file_id:a,path:i,mime:"image/jpeg"}),t.closeSync(r.fd)}catch(e){throw t.closeSync(r.fd),e}})(e)}catch(e){}throw new Error})(e)}catch(e){}try{return(e=>{try{return(e=>{let r=t.readFileSync(e,"utf8");JSON.parse(r);let n=e.split(s.sep),i=P(...n);M({file_id:i,path:n,mime:"application/json"})})(e)}catch(e){}throw new Error})(e)}catch(e){}}};H(f);let Q=y.files.filter((e=>/^image[/]/.test(e.mime)));y.audio.tracks.forEach((e=>{let t=O[e.file_id];if(void 0===t)return;const r=t.path.slice(0,-1).join("/");for(const t of Q)if(t.path.slice(0,-1).join("/")===r){let r=k[e.disc_id];if(void 0===r)continue;let s=A[r.album_id];if(void 0===s)continue;s.cover_file_id=t.file_id;break}}));for(const e of y.video.movie_parts){const t=O[e.file_id];if(null==t)continue;const r=w[e.movie_id];if(null==r)continue;const s=t.path.slice(0,-1).join("/");for(const e of Q)if(e.path.slice(0,-1).join("/")===s){r.poster_file_id=e.file_id;break}}const Y=y.files.filter((e=>/^video[/]/.test(e.mime))).sort(((e,t)=>{let r=e.path.join("/"),s=t.path.join("/");return r<s?-1:r>s?1:0})),Z=y.files.filter((e=>/^application[/]json$/.test(e.mime)));for(const e of Z){const r=e.path.slice(0,-1).join("/");let s=null;try{s=JSON.parse(t.readFileSync(e.path.join("/"),"utf8"))}catch(e){}if(null==s)continue;const n=Y.filter((e=>e.path.slice(0,-1).join("/")===r));if(h.is(s))for(let e of n){const t=y.video.movie_parts.find((t=>t.file_id===e.file_id));if(null==t)continue;const r=y.video.movies.find((e=>e.movie_id===t.movie_id));if(null!=r)for(const e of s.genres){const t=P("video",e);C({video_genre_id:t,title:e}),G({movie_id:r.movie_id,video_genre_id:t})}}else if(p.is(s))for(let e of n){const t=y.video.episodes.find((t=>t.file_id===e.file_id));if(null==t)continue;const r=y.video.seasons.find((e=>e.season_id===t.season_id));if(null==r)continue;const n=y.video.shows.find((e=>e.show_id===r.show_id));if(null!=n)for(const e of s.show.genres){const t=P("video",e);C({video_genre_id:t,title:e}),R({show_id:n.show_id,video_genre_id:t})}}}function ee(e){let t=e.path.slice(0,-1).join("/");return y.files.filter((e=>{let r=e.path.slice(0,-1).join("/");return t===r}))}let te=y.files.filter((e=>/^text[/]vtt$/.test(e.mime)));for(let e of te){let t=ee(e).filter((e=>/^video[/]/.test(e.mime)));if(t.length>0){let r=e.path[e.path.length-1].split(".");for(let s of t){let t=s.path[s.path.length-1].split(".");if(r[0]===t[0]){let t=e.file_id,n=P(t),i=r.reverse().find((e=>e in d))||null;(re={subtitle_id:n,file_id:t,video_file_id:s.file_id,language:i}).subtitle_id in S||(S[re.subtitle_id]=re,y.video.subtitles.push(re));break}}}}var re;y.video.subtitles.forEach((e=>{let r=O[e.file_id];if(void 0===r)return;let s=[".",...r.path].join("/");try{let r=(n=t.readFileSync(s,{encoding:"utf8"}),{head:function(e){a(e,"WEBVTT");let t=e.line();return l(e),{metadata:t}}(o=new i(n)),body:function(e){let t=new Array;for(;!e.done();){let r=u(e);t.push(r)}return{cues:t}}(o)}),c=JSON.parse(r.head.metadata);"object"==typeof c&&"string"==typeof c.language&&(e.language=c.language);let p=r.body.cues.map((e=>[e.start_ms,e.duration_ms,e.lines.join("\n")]));y.video.subtitle_contents.push({subtitle_id:e.subtitle_id,cues:p})}catch(e){console.log(s)}var n,o})),t.writeFileSync("./private/db/media.json",JSON.stringify(y,null,"\t"))})()})();