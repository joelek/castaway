(()=>{"use strict";var e={375:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Union=t.Undefined=t.Tuple=t.StringLiteral=t.String=t.Reference=t.Record=t.Object=t.NumberLiteral=t.Number=t.Null=t.Intersection=t.BooleanLiteral=t.Boolean=t.Array=t.Any=void 0,t.Any={as:(e,t="")=>e,is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Array={of:e=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Array){for(let n=0;n<t.length;n++)e.as(t[n],r+"["+n+"]");return t}throw"Expected an array at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Boolean={as(e,t=""){if(null!=e&&e.constructor===globalThis.Boolean)return e;throw"Expected a boolean at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.BooleanLiteral={of:e=>({as(t,r=""){if(t===e)return t;throw"Expected "+e+" at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Intersection={of:(...e)=>({as(t,r=""){for(let n of e)n.as(t,r);return t},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Null={as(e,t=""){if(null===e)return e;throw"Expected null at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Number={as(e,t=""){if(null!=e&&e.constructor===globalThis.Number)return e;throw"Expected a number at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.NumberLiteral={of:e=>({as(t,r=""){if(t===e)return t;throw"Expected "+e+" at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Object={of:e=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Object){for(let n in e)e[n].as(t[n],r+/^([a-z][a-z0-9_]*)$/is.test(n)?"."+n:'["'+n+'"]');return t}throw"Expected an object at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Record={of:e=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Object){for(let n of globalThis.Object.keys(t))e.as(t[n],r+'["'+n+'"]');return t}throw"Expected a record at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Reference={of:e=>({as:(t,r="")=>e().as(t,r),is:t=>e().is(t)})},t.String={as(e,t=""){if(null!=e&&e.constructor===globalThis.String)return e;throw"Expected a string at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.StringLiteral={of:e=>({as(t,r=""){if(t===e)return t;throw'Expected "'+e+'" at '+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Tuple={of:(...e)=>({as(t,r=""){if(null!=t&&t.constructor===globalThis.Array){for(let n=0;n<e.length;n++)e[n].as(t[n],r+"["+n+"]");return t}throw"Expected a tuple at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})},t.Undefined={as(e,t=""){if(void 0===e)return e;throw"Expected undefined at "+t+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}},t.Union={of:(...e)=>({as(t,r=""){for(let n of e)try{return n.as(t,r)}catch(e){}throw"Expected a union at "+r+"!"},is(e){try{this.as(e)}catch(e){return!1}return!0}})}},175:(e,t,r)=>{t.m7=t.l8=void 0;const n=r(375);t.l8=n;r(226);const s=r(129);t.m7=s;r(329)},226:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Schema=t.UnionType=t.UndefinedType=t.TupleType=t.StringLiteralType=t.StringType=t.ReferenceType=t.RecordType=t.ObjectType=t.NumberLiteralType=t.NumberType=t.NullType=t.IntersectionType=t.GroupType=t.BooleanLiteralType=t.BooleanType=t.ArrayType=t.AnyType=t.Type=void 0;const n=r(329);t.Type={parse(e,...t){try{return v.parse(e,...t)}catch(e){}try{return d.parse(e,...t)}catch(e){}try{return i.parse(e,...t)}catch(e){}try{return s.parse(e)}catch(e){}try{return o.parse(e)}catch(e){}try{return a.parse(e)}catch(e){}try{return c.parse(e)}catch(e){}try{return u.parse(e)}catch(e){}try{return f.parse(e)}catch(e){}try{return m.parse(e)}catch(e){}try{return b.parse(e)}catch(e){}try{return S.parse(e)}catch(e){}try{return g.parse(e)}catch(e){}try{return y.parse(e)}catch(e){}try{return p.parse(e)}catch(e){}try{return l.parse(e)}catch(e){}try{return h.parse(e)}catch(e){}return e.newContext(((e,t)=>{let r=e();throw`Unexpected ${r.family} at row ${r.row}, col ${r.col}!`}))}};class s{constructor(){}generateType(e){return"any"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\treturn subject;"),t.push("}")):t.push("autoguard.Any"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"any"),s.INSTANCE)))}}t.AnyType=s,s.INSTANCE=new s;class i{constructor(e){this.type=e}generateType(e){return this.type.generateType(e)+"[]"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Array)) {"),t.push("\t\tfor (let i = 0; i < subject.length; i++) {"),t.push("\t\t\t("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t\t"}))+')(subject[i], path + "[" + i + "]");'),t.push("\t\t}"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected an array at " + path + "!";'),t.push("}")):t.push("autoguard.Array.of("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}static parse(e,...r){if(r.includes("Array"))throw"Recursion prevention!";return e.newContext(((s,o)=>{let a=t.Type.parse(e,...r,"Array");n.expect(s(),"["),n.expect(s(),"]");let l=new i(a);for(;;)try{e.newContext(((e,t)=>{n.expect(e(),"["),n.expect(e(),"]"),l=new i(l)}))}catch(e){break}return l}))}}t.ArrayType=i;class o{constructor(){}generateType(e){return"boolean"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Boolean)) {"),t.push("\t\treturn subject as boolean;"),t.push("\t}"),t.push('\tthrow "Expected a boolean at " + path + "!";'),t.push("}")):t.push("autoguard.Boolean"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"boolean"),o.INSTANCE)))}}t.BooleanType=o,o.INSTANCE=new o;class a{constructor(e){this.value=e}generateType(e){return""+this.value}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected '+this.value+' at " + path + "!";'),t.push("}")):t.push("autoguard.BooleanLiteral.of("+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>"true"===n.expect(e(),["true","false"]).family?a.INSTANCE_TRUE:a.INSTANCE_FALSE))}}t.BooleanLiteralType=a,a.INSTANCE_TRUE=new a(!0),a.INSTANCE_FALSE=new a(!1);class l{constructor(e){this.type=e}generateType(e){return"("+this.type.generateType(e)+")"}generateTypeGuard(e){return this.type.generateTypeGuard(e)}static parse(e){return e.newContext(((r,s)=>{n.expect(r(),"(");let i=t.Type.parse(e);return n.expect(r(),")"),new l(i)}))}}t.GroupType=l;class d{constructor(){this.types=new Set}add(e){return this.types.add(e),this}generateType(e){let t=new Array;for(let r of this.types)t.push(r.generateType(e));return t.join(" & ")}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {");for(let r of this.types)t.push("\t("+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+")(subject, path);");return t.push("\treturn subject;"),t.push("}"),t.join(e.eol)}for(let r of this.types)t.push("\t"+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Intersection.of("+e.eol+t.join(","+e.eol)+e.eol+")"}static parse(e,...r){if(r.includes("Intersection"))throw"Recursion prevention!";return e.newContext(((s,i)=>{var o;let a=t.Type.parse(e,...r,"Intersection"),l=new d;for(l.add(a);"&"===(null===(o=i())||void 0===o?void 0:o.value);){n.expect(s(),"&");let i=t.Type.parse(e,...r,"Intersection");l.add(i)}return 1===l.types.size?a:l}))}}t.IntersectionType=d;class c{constructor(){}generateType(e){return"null"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === null) {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected null at " + path + "!";'),t.push("}")):t.push("autoguard.Null"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"null"),c.INSTANCE)))}}t.NullType=c,c.INSTANCE=new c;class u{constructor(){}generateType(e){return"number"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Number)) {"),t.push("\t\treturn subject as number;"),t.push("\t}"),t.push('\tthrow "Expected a number at " + path + "!";'),t.push("}")):t.push("autoguard.Number"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"number"),u.INSTANCE)))}}t.NumberType=u,u.INSTANCE=new u;class f{constructor(e){this.value=e}generateType(e){return""+this.value}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected '+this.value+' at " + path + "!";'),t.push("}")):t.push("autoguard.NumberLiteral.of("+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>{let r=n.expect(e(),"NUMBER_LITERAL").value;return new f(Number.parseInt(r))}))}}t.NumberLiteralType=f;class p{constructor(){this.members=new Map}add(e,t){return this.members.set(e,t),this}generateType(e){if(0===this.members.size)return"{}";let t=new Array;for(let[r,n]of this.members)t.push('\t"'+r+'"'+(n.optional?"?":"")+": "+n.type.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"{"+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"}"}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Object)) {");for(let[r,n]of this.members){let s=n.type;if(n.optional){let e=new v;e.add(S.INSTANCE),e.add(s),s=e}let i=/^([a-z][a-z0-9_]*)$/is.test(r)?'".'+r+'"':'"[\\"'+r+'\\"]"';t.push("\t\t("+s.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+')(subject["'+r+'"], path + '+i+");")}return t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected an object at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let[r,n]of this.members){let s=n.type;if(n.optional){let e=new v;e.add(S.INSTANCE),e.add(s),s=e}t.push('\t"'+r+'": '+s.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})))}return"autoguard.Object.of<"+(null!=this.typename?this.typename:this.generateType(e))+">({"+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"})"}setTypename(e){this.typename=e}static parse(e){return e.newContext(((r,s)=>{var i,o,a;n.expect(r(),"{");let l=new p;if("}"!==(null===(i=s())||void 0===i?void 0:i.value))for(;;){let i=!1,d=n.expect(r(),["any","boolean","false","null","number","string","true","undefined","IDENTIFIER","STRING_LITERAL"]),c="STRING_LITERAL"===d.family?d.value.slice(1,-1):d.value;"?"===(null===(o=s())||void 0===o?void 0:o.value)&&(r(),i=!0),n.expect(r(),":");let u=t.Type.parse(e);if(l.add(c,{type:u,optional:i}),","!==(null===(a=s())||void 0===a?void 0:a.value))break;n.expect(r(),",")}return n.expect(r(),"}"),l}))}}t.ObjectType=p;class h{constructor(e){this.type=e}generateType(e){return"Record<string, undefined | "+this.type.generateType(e)+">"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Object)) {"),t.push("\t\tfor (let key of globalThis.Object.keys(subject)) {"),t.push("\t\t\t("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t\t"}))+')(subject[key], path + "[\\"" + key + "\\"]");'),t.push("\t\t}"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected a record at " + path + "!";'),t.push("}")):t.push("autoguard.Record.of("+this.type.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+")"),t.join(e.eol)}static parse(e){return e.newContext(((r,s)=>{n.expect(r(),"{");let i=t.Type.parse(e);return n.expect(r(),"}"),new h(i)}))}}t.RecordType=h;class g{constructor(e){this.typename=e}generateType(e){return this.typename}generateTypeGuard(e){return e.standalone?this.typename+".as":"autoguard.Reference.of<"+this.typename+">(() => "+this.typename+")"}static parse(e){return e.newContext(((e,t)=>{var r;"@"===(null===(r=t())||void 0===r?void 0:r.family)&&n.expect(e(),"@");let s=n.expect(e(),"IDENTIFIER").value;return new g(s)}))}}t.ReferenceType=g;class m{constructor(){}generateType(e){return"string"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.String)) {"),t.push("\t\treturn subject as string;"),t.push("\t}"),t.push('\tthrow "Expected a string at " + path + "!";'),t.push("}")):t.push("autoguard.String"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"string"),m.INSTANCE)))}}t.StringType=m,m.INSTANCE=new m;class b{constructor(e){this.value=e}generateType(e){return'"'+this.value+'"'}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"}))+") {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected \\"'+this.value+'\\" at " + path + "!";'),t.push("}")):t.push('autoguard.StringLiteral.of("'+this.value+'")'),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>{let r=n.expect(e(),"STRING_LITERAL").value;return new b(r.slice(1,-1))}))}}t.StringLiteralType=b;class y{constructor(){this.types=new Array}add(e){return this.types.push(e),this}generateType(e){let t=new Array;for(let r of this.types)t.push("\t"+r.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"["+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+"]"}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {"),t.push("\tif ((subject != null) && (subject.constructor === globalThis.Array)) {");for(let r=0;r<this.types.length;r++){let n=this.types[r];t.push("\t\t("+n.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject["+r+'], path + "['+r+']");')}return t.push("\t\treturn subject as "+this.generateType(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+";"),t.push("\t}"),t.push('\tthrow "Expected a tuple at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let r of this.types)t.push("\t"+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Tuple.of("+(t.length>0?e.eol+t.join(","+e.eol)+e.eol:"")+")"}static parse(e){return e.newContext(((r,s)=>{var i,o;n.expect(r(),"[");let a=new y;if("]"!==(null===(i=s())||void 0===i?void 0:i.value))for(;;){let i=t.Type.parse(e);if(a.add(i),","!==(null===(o=s())||void 0===o?void 0:o.value))break;n.expect(r(),",")}return n.expect(r(),"]"),a}))}}t.TupleType=y;class S{constructor(){}generateType(e){return"undefined"}generateTypeGuard(e){let t=new Array;return e.standalone?(t.push("(subject, path) => {"),t.push("\tif (subject === undefined) {"),t.push("\t\treturn subject;"),t.push("\t}"),t.push('\tthrow "Expected undefined at " + path + "!";'),t.push("}")):t.push("autoguard.Undefined"),t.join(e.eol)}static parse(e){return e.newContext(((e,t)=>(n.expect(e(),"undefined"),S.INSTANCE)))}}t.UndefinedType=S,S.INSTANCE=new S;class v{constructor(){this.types=new Set}add(e){return this.types.add(e),this}generateType(e){let t=new Array;for(let r of this.types)t.push(r.generateType(e));return t.join(" | ")}generateTypeGuard(e){let t=new Array;if(e.standalone){t.push("(subject, path) => {");for(let r of this.types)t.push("\ttry {"),t.push("\t\treturn ("+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject, path);"),t.push("\t} catch (error) {}");return t.push('\tthrow "Expected a union at " + path + "!";'),t.push("}"),t.join(e.eol)}for(let r of this.types)t.push("\t"+r.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t"})));return"autoguard.Union.of("+e.eol+t.join(","+e.eol)+e.eol+")"}static parse(e,...r){if(r.includes("Union"))throw"Recursion prevention!";return e.newContext(((s,i)=>{var o;let a=t.Type.parse(e,...r,"Union"),l=new v;for(l.add(a);"|"===(null===(o=i())||void 0===o?void 0:o.value);){n.expect(s(),"|");let i=t.Type.parse(e,...r,"Union");l.add(i)}return 1===l.types.size?a:l}))}}t.UnionType=v;class _{constructor(){this.types=new Map}add(e,t){return this.types.set(e,t),this}generateModule(e){let t=new Array;t.push("// This file was auto-generated by @joelek/ts-autoguard. Edit at own risk."),t.push(""),e.standalone||(t.push('import { guards as autoguard } from "@joelek/ts-autoguard";'),t.push(""));for(let[r,n]of this.types)t.push("export type "+r+" = "+n.generateType(e)+";"),t.push(""),e.standalone?(t.push("export const "+r+" = {"),t.push('\tas(subject: any, path: string = ""): '+r+" {"),t.push("\t\treturn ("+n.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol+"\t\t"}))+")(subject, path);"),t.push("\t},"),t.push("\tis(subject: any): subject is "+r+" {"),t.push("\t\ttry {"),t.push("\t\t\tthis.as(subject);"),t.push("\t\t} catch (error) {"),t.push("\t\t\treturn false;"),t.push("\t\t}"),t.push("\t\treturn true;"),t.push("\t}"),t.push("};"),t.push("")):(t.push("export const "+r+" = "+n.generateTypeGuard(Object.assign(Object.assign({},e),{eol:e.eol}))+";"),t.push(""));let r=new p;for(let[e,t]of this.types)r.add(e,{type:new g(e),optional:!1});return t.push("export type Autoguard = "+r.generateType(e)+";"),t.push(""),t.push("export const Autoguard = "+r.generateType(e)+";"),t.push(""),t.join(e.eol)}static parse(e){return e.newContext(((r,s)=>{var i,o,a;n.expect(r(),"{");let l=new _;if("}"!==(null===(i=s())||void 0===i?void 0:i.value))for(;;){let i=n.expect(r(),"IDENTIFIER").value;n.expect(r(),":");let d=t.Type.parse(e);if(null===(o=d.setTypename)||void 0===o||o.call(d,i),l.add(i,d),","!==(null===(a=s())||void 0===a?void 0:a.value))break;n.expect(r(),",")}if(n.expect(r(),"}"),null!=s())throw"Expected end of stream!";return l}))}}t.Schema=_},129:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MessageSerializer=void 0,t.MessageSerializer=class{constructor(e){this.guards=e}deserialize(e,t){let r=JSON.parse(e);if(null==r||r.constructor!==Object||null==r.type||r.type.constructor!==String)throw"Invalid message envelope!";{let e=r.type,n=r.data,s=this.guards[e];if(void 0===s)throw'Unknown message type "'+e+'"!';t(e,s.as(n))}}serialize(e,t){return JSON.stringify({type:e,data:t})}}},329:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.expect=t.Tokenizer=t.Families=void 0,t.Families=["WS","(",")","[","]","{","}","?","|","&","@",",",":","any","boolean","false","null","number","string","true","undefined","IDENTIFIER","NUMBER_LITERAL","STRING_LITERAL"],t.Tokenizer=class{constructor(e){let t={WS:/^([\t\r\n ]+)/ius,"(":/^([\(])/ius,")":/^([\)])/ius,"[":/^([\[])/ius,"]":/^([\]])/ius,"{":/^([\{])/ius,"}":/^([\}])/ius,"?":/^([\?])/ius,"|":/^([\|])/ius,"&":/^([&])/ius,"@":/^([@])/ius,",":/^([,])/ius,":":/^([:])/ius,any:/^(any)/ius,boolean:/^(boolean)/ius,false:/^(false)/ius,null:/^(null)/ius,number:/^(number)/ius,string:/^(string)/ius,true:/^(true)/ius,undefined:/^(undefined)/ius,IDENTIFIER:/^([a-z][a-z0-9_]*)/ius,NUMBER_LITERAL:/^(([1-9][0-9]+)|([0-9]))/ius,STRING_LITERAL:/^(["][^"]*["])/ius},r=new Array,n=1,s=1;for(;e.length>0;){let i;for(let r in t){let n=r,s=t[n].exec(e);null!=s&&(null==i||s[1].length>i[1].length)&&(i=[n,s[1]])}if(null==i)throw`Unrecognized token at row ${n}, col ${s}!`;r.push({family:i[0],value:i[1],row:n,col:s}),e=e.slice(i[1].length);let o=i[1].split(/\r?\n/);o.length>1&&(n+=o.length-1,s=1),s+=o[o.length-1].length}this.tokens=r.filter((e=>"WS"!==e.family)),this.offset=0}peek(){return this.tokens[this.offset]}read(){if(this.offset>=this.tokens.length)throw"Unexpectedly reached end of stream!";return this.tokens[this.offset++]}newContext(e){let t=this.offset;try{return e((()=>this.read()),(()=>this.peek()))}catch(e){throw this.offset=t,e}}},t.expect=function(e,t){if(!(Array.isArray(t)?t:[t]).includes(e.family))throw`Unexpected ${e.family} at row ${e.row}, col ${e.col}!`;return e}},745:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketClient=void 0;const n=r(417),s=r(605),i=r(211),o=r(835),a=r(978),l=r(410),d=r(93),c=r(611),u=r(302);t.WebSocketClient=class{constructor(e){var t;this.state=c.ReadyState.CONNECTING,this.listeners=new a.routing.MessageRouter,this.pending=new Array,this.socket=void 0;let r=n.randomBytes(16).toString("base64"),d={Connection:"upgrade",Host:null!==(t=o.parse(e).host)&&void 0!==t?t:"","Sec-WebSocket-Key":r,"Sec-WebSocket-Version":"13",Upgrade:"websocket"};(()=>{if(e.startsWith("wss:"))return function(e,t){return new Promise(((r,n)=>{i.get(e,t).on("upgrade",((e,t,n)=>{r({response:e,socket:t,buffer:n})})).on("error",n)}))}("https:"+e.substring(4),{headers:d,rejectUnauthorized:!1});if(e.startsWith("ws:"))return function(e,t){return new Promise(((r,n)=>{s.get(e,t).on("upgrade",((e,t,n)=>{r({response:e,socket:t,buffer:n})})).on("error",n)}))}("http:"+e.substring(3),{headers:d});throw`Expected ${e} to be a WebSocket URL!`})().then((e=>{var t,s;let i=e.response,o=e.socket,a=e.buffer;if(o.on("close",(()=>{this.state=c.ReadyState.CLOSED,this.listeners.route("close",void 0)})),o.on("error",(()=>{this.state=c.ReadyState.CLOSING,this.listeners.route("error",void 0),o.end()})),101!==i.statusCode)return o.emit("error");if("upgrade"!==(null===(t=u.getHeader(i,"Connection"))||void 0===t?void 0:t.toLowerCase()))return o.emit("error");if("websocket"!==(null===(s=u.getHeader(i,"Upgrade"))||void 0===s?void 0:s.toLowerCase()))return o.emit("error");let d=n.createHash("sha1").update(r+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11").digest("base64");if(u.getHeader(i,"Sec-WebSocket-Accept")!==d)return o.emit("error");this.socket=o;let f=()=>{for(;;)try{let e={buffer:a,offset:0},t=l.decodeFrame(e);this.onFrame(o,t),a=a.slice(e.offset)}catch(e){break}};this.socket.on("data",(e=>{a=Buffer.concat([a,e]),f()})),this.state=c.ReadyState.OPEN,this.listeners.route("open",void 0),f()}))}onFrame(e,t){if(0!==t.reserved1||0!==t.reserved2||0!==t.reserved3)return this.close(c.StatusCode.PROTOCOL_ERROR);if(t.opcode<8){if(t.opcode!==l.WebSocketFrameType.CONTINUATION&&t.opcode!==l.WebSocketFrameType.TEXT&&t.opcode!=l.WebSocketFrameType.BINARY)return this.close(c.StatusCode.PROTOCOL_ERROR);if(0===this.pending.length){if(t.opcode===l.WebSocketFrameType.CONTINUATION)return this.close(c.StatusCode.PROTOCOL_ERROR)}else if(t.opcode!==l.WebSocketFrameType.CONTINUATION)return this.close(c.StatusCode.PROTOCOL_ERROR);if(this.pending.push(t.payload),1===t.final){let e=Buffer.concat(this.pending);this.pending.splice(0),this.listeners.route("message",{data:e.toString()})}}else{if(1!==t.final)return this.close(c.StatusCode.PROTOCOL_ERROR);if(t.payload.length>125)return this.close(c.StatusCode.PROTOCOL_ERROR);if(t.opcode===l.WebSocketFrameType.CLOSE){if(this.readyState===c.ReadyState.CLOSING)return e.end();e.write(l.encodeFrame(Object.assign(Object.assign({},t),{masked:1})),(()=>e.end()))}else if(t.opcode===l.WebSocketFrameType.PING)e.write(l.encodeFrame(Object.assign(Object.assign({},t),{opcode:10,masked:1})));else if(t.opcode!==l.WebSocketFrameType.PONG)return this.close(c.StatusCode.PROTOCOL_ERROR)}}addEventListener(e,t){this.listeners.addObserver(e,t)}close(e){if(this.state!==c.ReadyState.OPEN)throw"Expected socket to be open!";const t=this.socket;if(d.absent(t))throw"Expected socket to be open!";let r=Buffer.alloc(0);d.present(e)&&(r=Buffer.concat([Buffer.alloc(2),Buffer.from("Connection closed by client.")]),r.writeUInt16BE(e,0));let n=l.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:l.WebSocketFrameType.CLOSE,masked:1,payload:r});t.write(n),this.state=c.ReadyState.CLOSING}removeEventListener(e,t){this.listeners.removeObserver(e,t)}send(e){if(this.state!==c.ReadyState.OPEN)throw"Expected socket to be open!";let t=this.socket;if(d.absent(t))throw"Expected socket to be open!";let r=l.WebSocketFrameType.BINARY;e instanceof Buffer||(e=Buffer.from(e,"utf8"),r=l.WebSocketFrameType.TEXT);let n=l.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:r,masked:1,payload:e});t.write(n)}get readyState(){return this.state}}},410:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.encodeFrame=t.decodeFrame=t.WebSocketFrameType=void 0;const n=r(417);var s;(s=t.WebSocketFrameType||(t.WebSocketFrameType={}))[s.CONTINUATION=0]="CONTINUATION",s[s.TEXT=1]="TEXT",s[s.BINARY=2]="BINARY",s[s.UNUSED_3=3]="UNUSED_3",s[s.UNUSED_4=4]="UNUSED_4",s[s.UNUSED_5=5]="UNUSED_5",s[s.UNUSED_6=6]="UNUSED_6",s[s.UNUSED_7=7]="UNUSED_7",s[s.CLOSE=8]="CLOSE",s[s.PING=9]="PING",s[s.PONG=10]="PONG",s[s.UNUSED_B=11]="UNUSED_B",s[s.UNUSED_C=12]="UNUSED_C",s[s.UNUSED_D=13]="UNUSED_D",s[s.UNUSED_E=14]="UNUSED_E",s[s.UNUSED_F=15]="UNUSED_F",t.decodeFrame=function(e){let t=e.buffer.readUInt8(e.offset)>>7&1,r=e.buffer.readUInt8(e.offset)>>6&1,n=e.buffer.readUInt8(e.offset)>>5&1,s=e.buffer.readUInt8(e.offset)>>4&1,i=e.buffer.readUInt8(e.offset)>>0&15;e.offset+=1;let o=e.buffer.readUInt8(e.offset)>>7&1,a=e.buffer.readUInt8(e.offset)>>0&127;if(e.offset+=1,126===a){if(a=e.buffer.readUInt16BE(e.offset),e.offset+=2,a<=125)throw"Invalid frame encoding!"}else if(127===a){if(0!==e.buffer.readUInt32BE(e.offset))throw"Invalid frame encoding!";if(e.offset+=4,a=e.buffer.readUInt32BE(e.offset),e.offset+=4,a<=65535)throw"Invalid frame encoding!"}let l=Buffer.alloc(4);if(1===o&&(l=e.buffer.slice(e.offset,e.offset+4),e.offset+=4),e.offset+a>e.buffer.length)throw"Invalid frame encoding!";let d=e.buffer.slice(e.offset,e.offset+a);if(e.offset+=a,1===o)for(let e=0;e<d.length;e++)d[e]=d[e]^l[3&e];return{final:t,reserved1:r,reserved2:n,reserved3:s,opcode:i,masked:o,payload:d}},t.encodeFrame=function(e){let t=new Array,r=e.payload.length,s=Buffer.alloc(2);t.push(s);let i=0;if(i|=(1&e.final)<<7,i|=(1&e.reserved1)<<6,i|=(1&e.reserved2)<<5,i|=(1&e.reserved3)<<4,i|=(15&e.opcode)<<0,s.writeUInt8(i,0),r<=125){let t=0;t|=(1&e.masked)<<7,t|=(127&r)<<0,s.writeUInt8(t,1)}else if(r<=65535){let n=0;n|=(1&e.masked)<<7,n|=126,s.writeUInt8(n,1);let i=Buffer.alloc(2);i.writeUInt16BE(r,0),t.push(i)}else{if(!(r<=4294967295))throw"Invalid frame size!";{let n=0;n|=(1&e.masked)<<7,n|=127,s.writeUInt8(n,1);let i=Buffer.alloc(8);i.writeUInt32BE(r,4),t.push(i)}}if(1===e.masked){let r=n.randomBytes(4),s=Buffer.concat([e.payload]);for(let e=0;e<s.length;e++)s[e]=s[e]^r[3&e];t.push(r,s)}else t.push(e.payload);return Buffer.concat(t)}},545:(e,t,r)=>{r(745),r(410),r(447),r(611);var n=r(745);Object.defineProperty(t,"yU",{enumerable:!0,get:function(){return n.WebSocketClient}});var s=r(447);Object.defineProperty(t,"u9",{enumerable:!0,get:function(){return s.WebSocketServer}})},93:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.present=t.absent=void 0,t.absent=function(e){return null==e},t.present=function(e){return null!=e}},447:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketServer=void 0;const n=r(417),s=r(16),i=r(978),o=r(410),a=r(93),l=r(611),d=r(302);t.WebSocketServer=class{constructor(){this.pending_chunks=new Map,this.states=new Map,this.connections=new d.BiMap,this.router=new i.routing.MessageRouter}onFrame(e,t,r,n){if(0!==n.reserved1||0!==n.reserved2||0!==n.reserved3)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(1!==n.masked)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(n.opcode<8){if(n.opcode!==o.WebSocketFrameType.CONTINUATION&&n.opcode!==o.WebSocketFrameType.TEXT&&n.opcode!=o.WebSocketFrameType.BINARY)return this.close(e,l.StatusCode.PROTOCOL_ERROR);{let r=this.pending_chunks.get(e);if(a.absent(r))r=new Array,this.pending_chunks.set(e,r);else if(n.opcode!==o.WebSocketFrameType.CONTINUATION)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(r.push(n.payload),1===n.final){let n=Buffer.concat(r);this.pending_chunks.delete(e),this.router.route("message",{connection_id:e,connection_url:t,buffer:n})}}}else{if(1!==n.final)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(n.payload.length>125)return this.close(e,l.StatusCode.PROTOCOL_ERROR);if(n.opcode===o.WebSocketFrameType.CLOSE){if(this.states.get(e)===l.ReadyState.CLOSING)return r.end();r.write(o.encodeFrame(Object.assign(Object.assign({},n),{masked:0})),(()=>r.end()))}else if(n.opcode===o.WebSocketFrameType.PING)r.write(o.encodeFrame(Object.assign(Object.assign({},n),{opcode:10,masked:0})));else if(n.opcode!==o.WebSocketFrameType.PONG)return this.close(e,l.StatusCode.PROTOCOL_ERROR)}}broadcast(e){for(let[t,r]of this.connections)this.states.get(t)===l.ReadyState.OPEN&&this.send(t,e)}addEventListener(e,t){return this.router.addObserver(e,t)}close(e,t){if(this.states.get(e)!==l.ReadyState.OPEN)throw"Expected socket to be open!";const r=this.connections.value(e);if(a.absent(r))throw'Connection with id "'+e+'" has no socket!';let n=Buffer.alloc(0);a.present(t)&&(n=Buffer.concat([Buffer.alloc(2),Buffer.from("Connection closed by server.")]),n.writeUInt16BE(t,0));let s=o.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:o.WebSocketFrameType.CLOSE,masked:0,payload:n});r.write(s),this.states.set(e,l.ReadyState.CLOSING)}getRequestHandler(){return(e,t)=>{let r=e.socket,i=this.connections.key(r);if(a.present(i))return t.writeHead(400),t.end();let c=e.httpVersionMajor,u=e.httpVersionMinor;if(c<1||1===c&&u<1)return t.writeHead(400),t.end();if("GET"!==e.method)return t.writeHead(400),t.end();let f=d.getHeader(e,"Host");if(a.absent(f))return t.writeHead(400),t.end();let p=d.getHeader(e,"Upgrade");if(a.absent(p)||"websocket"!==p.toLowerCase())return t.writeHead(400),t.end();let h=d.getHeader(e,"Connection");if(a.absent(h)||"upgrade"!==h.toLowerCase())return t.writeHead(400),t.end();let g=d.getHeader(e,"Sec-WebSocket-Key");if(a.absent(g)||16!==Buffer.from(g,"base64").length)return t.writeHead(400),t.end();if("13"!==d.getHeader(e,"Sec-WebSocket-Version"))return t.writeHead(426,{"Sec-WebSocket-Version":"13"}),t.end();let m=n.createHash("sha1").update(g+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11").digest("base64");return t.writeHead(101,{Upgrade:"websocket",Connection:"Upgrade","Sec-WebSocket-Accept":m}),t.end((()=>{let t=n.randomBytes(16).toString("hex"),i=function(e){let t=e.headers.host||"",r=e.url||"/";return`${e.socket instanceof s.TLSSocket?"wss:":"ws:"}//${t}${r}`}(e),a=Buffer.alloc(0);r.on("data",(e=>{for(a=Buffer.concat([a,e]);;)try{let e={buffer:a,offset:0},n=o.decodeFrame(e);this.onFrame(t,i,r,n),a=a.slice(e.offset)}catch(e){break}})),r.on("close",(()=>{this.connections.remove(t),this.states.delete(t),this.router.route("disconnect",{connection_id:t,connection_url:i})})),r.setTimeout(0),this.connections.add(t,r),this.states.set(t,l.ReadyState.OPEN),this.router.route("connect",{connection_id:t,connection_url:i})}))}}removeEventListener(e,t){return this.router.removeObserver(e,t)}send(e,t){if(this.states.get(e)!==l.ReadyState.OPEN)throw"Expected socket to be open!";let r=this.connections.value(e);if(a.absent(r))throw'Connection with id "'+e+'" has no socket!';let n=o.WebSocketFrameType.BINARY;t instanceof Buffer||(t=Buffer.from(t,"utf8"),n=o.WebSocketFrameType.TEXT);let s=o.encodeFrame({final:1,reserved1:0,reserved2:0,reserved3:0,opcode:n,masked:0,payload:t});r.write(s)}}},611:(e,t)=>{var r,n;Object.defineProperty(t,"__esModule",{value:!0}),t.StatusCode=t.ReadyState=void 0,(n=t.ReadyState||(t.ReadyState={}))[n.CONNECTING=0]="CONNECTING",n[n.OPEN=1]="OPEN",n[n.CLOSING=2]="CLOSING",n[n.CLOSED=3]="CLOSED",(r=t.StatusCode||(t.StatusCode={}))[r.NORMAL=1e3]="NORMAL",r[r.GOING_AWAY=1001]="GOING_AWAY",r[r.PROTOCOL_ERROR=1002]="PROTOCOL_ERROR",r[r.DATA_TYPE_NOT_ACCEPTED=1003]="DATA_TYPE_NOT_ACCEPTED",r[r.RESERVED_1004=1004]="RESERVED_1004",r[r.RESERVED_1005=1005]="RESERVED_1005",r[r.RESERVED_1006=1006]="RESERVED_1006",r[r.BAD_DATA_TYPE=1007]="BAD_DATA_TYPE",r[r.POLICY_VIOLATION=1008]="POLICY_VIOLATION",r[r.MESSAGE_TOO_BIG=1009]="MESSAGE_TOO_BIG",r[r.CLIENT_EXPECTED_EXTENSION=1010]="CLIENT_EXPECTED_EXTENSION",r[r.SERVER_UNEXPECTED_CONDITION=1011]="SERVER_UNEXPECTED_CONDITION",r[r.RESERVED_1015=1015]="RESERVED_1015"},302:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BiMap=t.getHeader=void 0;const n=r(93);t.getHeader=function(e,t){let r=e.headers[t.toLowerCase()];if(n.present(r)){if(r.constructor===String)return r;if(r.constructor===Array&&1===r.length)return r[0]}return null};class s{constructor(){this.value_to_key=new Map,this.key_to_value=new Map}[Symbol.iterator](){return this.key_to_value[Symbol.iterator]()}add(e,t){this.value_to_key.set(t,e),this.key_to_value.set(e,t)}key(e){return this.value_to_key.get(e)||null}remove(e){let t=this.key_to_value.get(e);n.present(t)&&this.value_to_key.delete(t),this.key_to_value.delete(e)}value(e){return this.key_to_value.get(e)||null}}t.BiMap=s},978:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.routing=r(220)},220:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.NamespacedMessageRouter=t.MessageRouter=void 0;class r{constructor(){this.observers=new Map}addObserver(e,t){let r=this.observers.get(e);void 0===r&&(r=new Set,this.observers.set(e,r)),r.add(t)}removeObserver(e,t){let r=this.observers.get(e);void 0!==r&&r.delete(t)}route(e,t){let r=this.observers.get(e);if(void 0!==r)for(let e of r)e(t)}}t.MessageRouter=r,t.NamespacedMessageRouter=class{constructor(){this.routers=new Map}addObserver(e,t,n){let s=this.routers.get(e);void 0===s&&(s=new r,this.routers.set(e,s)),s.addObserver(t,n)}removeObserver(e,t,r){let n=this.routers.get(e);void 0!==n&&n.removeObserver(t,r)}route(e,t,r){let n=this.routers.get(e);void 0!==n&&n.route(t,r)}}},417:e=>{e.exports=require("crypto")},605:e=>{e.exports=require("http")},211:e=>{e.exports=require("https")},16:e=>{e.exports=require("tls")},835:e=>{e.exports=require("url")}},t={};function r(n){if(t[n])return t[n].exports;var s=t[n]={exports:{}};return e[n](s,s.exports,r),s.exports}(()=>{const e=require("fs");var t=r(605),n=r(211);const s=require("path");var i=r(835),o=r(417),a=r(175);const l=a.l8.Object.of({artist_id:a.l8.String,title:a.l8.String}),d=a.l8.Object.of({album_id:a.l8.String,title:a.l8.String,year:a.l8.Number,cover_file_id:a.l8.Union.of(a.l8.String,a.l8.Null)}),c=a.l8.Object.of({disc_id:a.l8.String,album_id:a.l8.String,number:a.l8.Number}),u=a.l8.Object.of({track_id:a.l8.String,disc_id:a.l8.String,file_id:a.l8.String,title:a.l8.String,number:a.l8.Number,duration:a.l8.Number}),f=a.l8.Object.of({album_id:a.l8.String,artist_id:a.l8.String}),p=a.l8.Object.of({track_id:a.l8.String,artist_id:a.l8.String}),h=a.l8.Object.of({video_genre_id:a.l8.String,title:a.l8.String}),g=a.l8.Object.of({movie_id:a.l8.String,title:a.l8.String,year:a.l8.Number,summary:a.l8.Union.of(a.l8.String,a.l8.Null),poster_file_id:a.l8.Union.of(a.l8.String,a.l8.Null)}),m=a.l8.Object.of({movie_id:a.l8.String,video_genre_id:a.l8.String}),b=a.l8.Object.of({movie_part_id:a.l8.String,movie_id:a.l8.String,file_id:a.l8.String,duration:a.l8.Number,number:a.l8.Number}),y=a.l8.Object.of({show_id:a.l8.String,title:a.l8.String}),S=a.l8.Object.of({show_id:a.l8.String,video_genre_id:a.l8.String}),v=a.l8.Object.of({season_id:a.l8.String,show_id:a.l8.String,number:a.l8.Number}),_=a.l8.Object.of({episode_id:a.l8.String,season_id:a.l8.String,file_id:a.l8.String,title:a.l8.String,number:a.l8.Number,duration:a.l8.Number,year:a.l8.Union.of(a.l8.Number,a.l8.Null),summary:a.l8.Union.of(a.l8.String,a.l8.Null)}),w=a.l8.Object.of({subtitle_id:a.l8.String,file_id:a.l8.String,video_file_id:a.l8.String,language:a.l8.Union.of(a.l8.String,a.l8.Null)}),O=a.l8.Object.of({subtitle_id:a.l8.String,cues:a.l8.Array.of(a.l8.Tuple.of(a.l8.Number,a.l8.Number,a.l8.String))}),E=(a.l8.Object.of({cue_id:a.l8.String,subtitle_id:a.l8.String,start_ms:a.l8.Number,duration_ms:a.l8.Number,lines:a.l8.Array.of(a.l8.String)}),a.l8.Object.of({file_id:a.l8.String,path:a.l8.Array.of(a.l8.String),mime:a.l8.String})),T=a.l8.Object.of({audio:a.l8.Object.of({artists:a.l8.Array.of(a.l8.Reference.of((()=>l))),albums:a.l8.Array.of(a.l8.Reference.of((()=>d))),discs:a.l8.Array.of(a.l8.Reference.of((()=>c))),tracks:a.l8.Array.of(a.l8.Reference.of((()=>u))),album_artists:a.l8.Array.of(a.l8.Reference.of((()=>f))),track_artists:a.l8.Array.of(a.l8.Reference.of((()=>p)))}),video:a.l8.Object.of({genres:a.l8.Array.of(a.l8.Reference.of((()=>h))),movie_parts:a.l8.Array.of(a.l8.Reference.of((()=>b))),movies:a.l8.Array.of(a.l8.Reference.of((()=>g))),movie_genres:a.l8.Array.of(a.l8.Reference.of((()=>m))),shows:a.l8.Array.of(a.l8.Reference.of((()=>y))),show_genres:a.l8.Array.of(a.l8.Reference.of((()=>S))),seasons:a.l8.Array.of(a.l8.Reference.of((()=>v))),episodes:a.l8.Array.of(a.l8.Reference.of((()=>_))),subtitles:a.l8.Array.of(a.l8.Reference.of((()=>w))),subtitle_contents:a.l8.Array.of(a.l8.Reference.of((()=>O)))}),files:a.l8.Array.of(a.l8.Reference.of((()=>E)))}),j=(a.l8.Record.of(a.l8.Array.of(a.l8.String)),a.l8.Object.of({audiolist_id:a.l8.String,title:a.l8.String})),I=a.l8.Object.of({audiolist_id:a.l8.String,track_id:a.l8.String,number:a.l8.Number}),N=a.l8.Object.of({audiolists:a.l8.Array.of(a.l8.Reference.of((()=>j))),audiolist_items:a.l8.Array.of(a.l8.Reference.of((()=>I)))}),k=a.l8.Object.of({user_id:a.l8.String,username:a.l8.String,password:a.l8.String}),R=a.l8.Object.of({username:a.l8.String,selector:a.l8.String,validator_hash:a.l8.String,expires_ms:a.l8.Number}),x=a.l8.Object.of({users:a.l8.Array.of(a.l8.Reference.of((()=>k))),tokens:a.l8.Array.of(a.l8.Reference.of((()=>R)))}),U=a.l8.Object.of({username:a.l8.String,file_id:a.l8.String,timestamp_ms:a.l8.Number}),A=a.l8.Object.of({streams:a.l8.Array.of(a.l8.Reference.of((()=>U)))}),C=a.l8.Object.of({channel_id:a.l8.String}),L=a.l8.Object.of({program_id:a.l8.String,channel_id:a.l8.String,file_id:a.l8.String,start_time_ms:a.l8.Number}),D=a.l8.Object.of({channels:a.l8.Array.of(a.l8.Reference.of((()=>C))),programs:a.l8.Array.of(a.l8.Reference.of((()=>L)))});function P(...e){return e.map((e=>String(e))).join("")}function B(e){let t=e;return t=t.toLowerCase(),t=t.normalize("NFC"),Array.from(t.match(/(\p{L}+|\p{N}+)/gu)||[])}function H(e){let t=Math.floor(e/1e3);e-=1e3*t;let r=Math.floor(t/60);t-=60*r;let n=Math.floor(r/60);r-=60*n;let s=P("00",n).slice(-2),i=P("00",r).slice(-2),o=P("00",t).slice(-2),a=P("000",e).slice(-3);return P(s,":",i,":",o,".",a)}const M=e=>(t,r)=>{let n=t[e],s=r[e];return null==n?null==s?0:1:null==s?null==n?0:-1:n-s};if(e.mkdirSync("./private/db/",{recursive:!0}),!e.existsSync("./private/db/streams.json")){let t={streams:[]};e.writeFileSync("./private/db/streams.json",JSON.stringify(t,null,"\t"))}if(!e.existsSync("./private/db/lists.json")){let t={audiolists:[],audiolist_items:[]};e.writeFileSync("./private/db/lists.json",JSON.stringify(t,null,"\t"))}if(!e.existsSync("./private/db/users.json")){let t={users:[{user_id:"",username:"test",password:function(e){let t=o.randomBytes(16),r=o.scryptSync("test",t,32,{N:16384,r:8,p:1,maxmem:33554432}),n=Buffer.alloc(4);return n[0]=0,n[1]=14,n[2]=8,n[3]=1,`$s0$${n.toString("hex")}$${t.toString("base64")}$${r.toString("base64")}`}()}],tokens:[]};e.writeFileSync("./private/db/users.json",JSON.stringify(t,null,"\t"))}if(e.existsSync("./private/db/media.json")||(process.stderr.write("Media database not found! Please run the indexer.\n"),process.exit(1)),!e.existsSync("./private/db/channels.json")){let t={channels:[],programs:[]};e.writeFileSync("./private/db/channels.json",JSON.stringify(t,null,"\t"))}let G=A.as(JSON.parse(e.readFileSync("./private/db/streams.json","utf8"))),F=N.as(JSON.parse(e.readFileSync("./private/db/lists.json","utf8"))),q=x.as(JSON.parse(e.readFileSync("./private/db/users.json","utf8"))),$=T.as(JSON.parse(e.readFileSync("./private/db/media.json","utf8"))),z=D.as(JSON.parse(e.readFileSync("./private/db/channels.json","utf8"))),J={};for(let e=0;e<q.users.length;e++){let t=q.users[e];J[t.username]=t}let W={};for(let e=0;e<q.tokens.length;e++){let t=q.tokens[e];W[t.selector]=t}let V={};for(let e=0;e<$.audio.tracks.length;e++){let t=$.audio.tracks[e];V[t.track_id]=t}let X={};for(let e=0;e<$.audio.discs.length;e++){let t=$.audio.discs[e];X[t.disc_id]=t}let Y={};for(let e=0;e<$.audio.albums.length;e++){let t=$.audio.albums[e];Y[t.album_id]=t}let K={};for(let e=0;e<$.audio.artists.length;e++){let t=$.audio.artists[e];K[t.artist_id]=t}let Q={};for(let e=0;e<$.video.shows.length;e++){let t=$.video.shows[e];Q[t.show_id]=t}let Z={};for(let e=0;e<$.video.episodes.length;e++){let t=$.video.episodes[e];Z[t.episode_id]=t}let ee={};for(let e=0;e<$.video.seasons.length;e++){let t=$.video.seasons[e];ee[t.season_id]=t}let te={};for(let e=0;e<$.video.movie_parts.length;e++){let t=$.video.movie_parts[e];te[t.movie_part_id]=t}let re={};for(let e=0;e<$.video.movies.length;e++){let t=$.video.movies[e];re[t.movie_id]=t}let ne={};for(let e=0;e<$.video.genres.length;e++){let t=$.video.genres[e];ne[t.video_genre_id]=t}let se={};for(let e=0;e<$.video.subtitles.length;e++){let t=$.video.subtitles[e];se[t.subtitle_id]=t}let ie={};for(let e of $.video.subtitle_contents)for(let t of e.cues){let r=le(e.subtitle_id,t),n=e.subtitle_id,s=t[0],i=t[1],o=t[2].split("\n");ie[r]={cue_id:r,subtitle_id:n,start_ms:s,duration_ms:i,lines:o}}let oe={};for(let e=0;e<$.files.length;e++){let t=$.files[e];oe[t.file_id]=t}let ae={};for(let e=0;e<F.audiolists.length;e++){let t=F.audiolists[e];ae[t.audiolist_id]=t}function le(e,t){let r=o.createHash("md5");return r.update(e),r.update(""+t[0]),r.digest("hex")}const de=new Map;for(let e of $.video.subtitle_contents)for(let t of e.cues){let r=le(e.subtitle_id,t);for(let e of t[2].split("\n")){let t=B(e).filter((e=>e.length>=4));for(let e of t){let t=de.get(e);void 0===t&&(t=new Set,de.set(e,t)),t.add(r)}}}setInterval((()=>{q.tokens=q.tokens.filter((e=>e.expires_ms>Date.now())),W={};for(let e of q.tokens)W[e.selector]=e;e.writeFileSync("./private/db/users.json",JSON.stringify(q,null,"\t"))}),36e5);class ce{constructor(){this.map=new Map}insert(e,t){this.map.set(e,t)}lookup(e){let t=this.map.get(e);if(null==t)throw`Expected "${e}" to match a record!`;return t}remove(e){this.map.delete(e)}static from(e,t){let r=new ce;for(let n of t)r.insert(n[e],n);return r}}class ue{constructor(){this.map=new Map}insert(e,t){let r=this.map.get(e);r||(r=new Set,this.map.set(e,r)),r.add(t)}lookup(e){let t=this.map.get(e);return t?Array.from(t):new Array}remove(e,t){let r=this.map.get(e);r&&(r.delete(t),0===r.size&&this.map.delete(e))}static from(e,t){let r=new ue;for(let n of t)r.insert(n[e],n);return r}}function fe(e,t){let r=e[t];if(null==r)throw`Expected "${t}" to match a record!`;return r}let pe=ce.from("file_id",$.video.episodes),he=ce.from("file_id",$.video.movie_parts),ge=ue.from("movie_id",$.video.movie_parts),me=ue.from("show_id",$.video.show_genres),be=(ue.from("movie_id",$.video.movie_genres),ue.from("video_genre_id",$.video.movie_genres)),ye=ue.from("video_genre_id",$.video.show_genres),Se=ce.from("video_genre_id",$.video.genres),ve=ue.from("show_id",$.video.seasons),_e=ue.from("season_id",$.video.episodes),we=ue.from("file_id",G.streams),Oe=ce.from("channel_id",z.channels),Ee=ue.from("channel_id",z.programs);function Te(t){return z.programs.push(t),e.writeFileSync("./private/db/channels.json",JSON.stringify(z,null,"\t")),Ee.insert(t.channel_id,t),t}function je(e){return ve.lookup(e).map((e=>{let t=_e.lookup(e.season_id);return Object.assign(Object.assign({},e),{episodes:t})}))}function Ie(e){return ge.lookup(e).map((e=>{let t=Ae.lookup(e.file_id);return Object.assign(Object.assign({},e),{subtitles:t})}))}function Ne(e){try{return pe.lookup(e)}catch(e){}try{return he.lookup(e)}catch(e){}throw`Expected "${e}" to match a metadata record!`}let ke=ue.from("album_id",$.audio.album_artists);const Re=ue.from("artist_id",$.audio.album_artists);let xe=ue.from("track_id",$.audio.track_artists),Ue=ue.from("artist_id",$.audio.track_artists),Ae=ue.from("video_file_id",$.video.subtitles);const Ce=ue.from("album_id",$.audio.discs),Le=ue.from("disc_id",$.audio.tracks),De=ce.from("album_id",$.audio.albums),Pe=ue.from("audiolist_id",F.audiolist_items),Be=ce.from("track_id",$.audio.tracks),He=ce.from("disc_id",$.audio.discs);function Me(e){return Ae.lookup(e).map((e=>Object.assign({},e)))}function Ge(e){let t=fe(K,e);return Object.assign({},t)}function Fe(e){return ke.lookup(e).map((e=>Ge(e.artist_id)))}function qe(e){let t=fe(Y,e),r=Fe(t.album_id);return Object.assign(Object.assign({},t),{artists:r})}function $e(e){return xe.lookup(e).map((e=>Ge(e.artist_id)))}function ze(e){let t=fe(V,e),r=function(e){let t=fe(X,e),r=qe(t.album_id);return Object.assign(Object.assign({},t),{album:r})}(t.disc_id),n=$e(t.track_id);return Object.assign(Object.assign({},t),{disc:r,artists:n})}function Je(e){let t=fe(re,e);return Object.assign({},t)}function We(e){let t=fe(Q,e);return Object.assign({},t)}function Ve(e){let t=fe(Z,e),r=function(e){let t=fe(ee,e),r=We(t.show_id);return Object.assign(Object.assign({},t),{show:r})}(t.season_id);return Object.assign(Object.assign({},t),{season:r})}class Xe{constructor(){this.map=new Map}insert(e,t){let r=this.map.get(e);r||(r=new Set,this.map.set(e,r)),r.add(t)}lookup(e){let t=this.map.get(e);return t?new Set(t):new Set}remove(e,t){let r=this.map.get(e);r&&(r.delete(t),0===r.size&&this.map.delete(e))}search(e,t){let r=B(e).map((e=>this.map.get(e)||new Set));r=r.filter((e=>e.size>0)),r=r.sort(((e,t)=>e.size-t.size));let n=new Array;if(r.length>0)e:for(let e of r[0]){for(let t=1;t<r.length;t++)if(!r[t].has(e))continue e;if(n.push(e),null!=t&&n.length>=t)break e}return n}static from(e,t,r){let n=new Xe;for(let s of r){let r=B(s[t]);for(let t of r)n.insert(t,s[e])}return n}}let Ye=Xe.from("artist_id","title",$.audio.artists),Ke=Xe.from("album_id","title",$.audio.albums),Qe=Xe.from("track_id","title",$.audio.tracks),Ze=Xe.from("show_id","title",$.video.shows),et=Xe.from("movie_id","title",$.video.movies),tt=Xe.from("episode_id","title",$.video.episodes);function rt(e,t){var r;return(null===(r=function(e,t){return we.lookup(t).filter((t=>t.username===e)).sort(M("timestamp_ms"))}(e,t).pop())||void 0===r?void 0:r.timestamp_ms)||null}function nt(t,r){let n=J[t];if(!n)throw new Error;if(!function(e,t){let r=/^\$s0\$([0-9a-fA-F]{8})\$([A-Za-z0-9+/]{22}==)\$([A-Za-z0-9+/]{43}=)$/.exec(t);if(null==r)throw"Expected a valid scrypt chunk!";let n=Buffer.from(r[1],"hex"),s=Buffer.from(r[2],"base64"),i=Buffer.from(r[3],"base64"),a=n[0]<<8|n[1]<<0,l=n[2]<<0,d=n[3]<<0,c=o.scryptSync(e,s,32,{N:1<<a,r:l,p:d,maxmem:(256<<a)*l});return o.timingSafeEqual(i,c)}(r,n.password))throw new Error("Fak u dolan.");return function(t){let r=o.randomBytes(16),n=o.randomBytes(16),s=o.createHash("sha256");s.update(n);let i=s.digest("hex");var a;return a={username:t,selector:r.toString("hex"),validator_hash:i,expires_ms:Date.now()+6048e5},q.tokens.push(a),W[a.selector]=a,e.writeFileSync("./private/db/users.json",JSON.stringify(q,null,"\t")),`${r.toString("hex")}${n.toString("hex")}`}(t)}function st(t){let r=/^([0-9a-f]{32})([0-9a-f]{32})$/.exec(t);if(!r)throw new Error;let n=r[1],s=r[2],i=W[n];if(!i)throw new Error;let a=o.createHash("sha256");a.update(Buffer.from(s,"hex"));let l=a.digest();if(!o.timingSafeEqual(Buffer.from(i.validator_hash,"hex"),l))throw new Error;let d=Date.now()+6048e5;return function(t){let r=W[t.selector];r&&(r.expires_ms=t.expires_ms),e.writeFileSync("./private/db/users.json",JSON.stringify(q,null,"\t"))}(Object.assign(Object.assign({},i),{expires_ms:d})),i.username}const it=require("child_process"),ot=a.l8.Object.of({pkt_pts_time:a.l8.String}),at=a.l8.Object.of({frames:a.l8.Array.of(a.l8.Reference.of((()=>ot)))}),lt=a.l8.Object.of({start_time:a.l8.String,duration:a.l8.String}),dt=a.l8.Object.of({streams:a.l8.Array.of(a.l8.Reference.of((()=>lt)))});var ct=function(e,t,r,n){return new(r||(r=Promise))((function(s,i){function o(e){try{l(n.next(e))}catch(e){i(e)}}function a(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};function ut(e,t){return ct(this,void 0,void 0,(function*(){return new Promise(((r,n)=>{let s=it.spawn("ffprobe",["-hide_banner","-i",e.join("/"),"-select_streams",""+t,"-skip_frame","nokey","-show_frames","-show_entries","frame=pkt_pts_time","-of","json"]),i=new Array;s.stdout.on("data",(e=>{i.push(e)})),s.on("exit",(()=>{let e=Buffer.concat(i).toString(),t=at.as(JSON.parse(e)).frames.map((e=>Math.round(1e3*Number.parseFloat(e.pkt_pts_time))));r(t)}))}))}))}var ft=function(e,t,r,n){return new(r||(r=Promise))((function(s,i){function o(e){try{l(n.next(e))}catch(e){i(e)}}function a(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};function pt(e){(e%=2147483647)<=0&&(e+=2147483646);const t=()=>((e=16807*e%2147483647)-1)/2147483646;return t(),t}function ht(e){const t=pt(e)()<.5?"Movies":"Shows",r=function(e){const t=pt(e);return $.video.genres.map((e=>({genre:e,weight:t()})))}(e).sort(((e,t)=>t.weight-e.weight));return{channel_id:e,title:r[0].genre.title+" & "+r[1].genre.title+" "+t}}function gt(t){let r;try{n=""+t,r=Oe.lookup(n)}catch(e){}var n;r||(r=function(t){return z.channels.push(t),e.writeFileSync("./private/db/channels.json",JSON.stringify(z,null,"\t")),Oe.insert(t.channel_id,t),t}({channel_id:""+t}));let s=function(e){return Ee.lookup(e).sort(M("start_time_ms"))}(""+t),i=new Date;i.setUTCHours(0),i.setUTCMinutes(0),i.setUTCSeconds(0),i.setUTCMilliseconds(0);let a=i.valueOf(),l=Date.now();if(s.length>0){let e=s[s.length-1],t=Ne(e.file_id);a=e.start_time_ms+t.duration}let d=l+216e5;if(a>=d)return s;for(;a<d;){let e=Math.floor(Math.random()*$.video.episodes.length),r=$.video.episodes[e],n=Te({program_id:o.createHash("md5").update(""+t).update("\0").update(""+a).digest("hex"),channel_id:""+t,file_id:r.file_id,start_time_ms:a});s.push(n),a+=r.duration}return s}let mt={};function bt(e){return ft(this,void 0,void 0,(function*(){let t=mt[e];if(!t){let r=oe[e];t=yield function(e,t,r){return ct(this,void 0,void 0,(function*(){let n=yield function(e){return ct(this,void 0,void 0,(function*(){return new Promise(((t,r)=>{let n=it.spawn("ffprobe",["-hide_banner","-i",e.join("/"),"-show_streams","-show_entries","stream=start_time,duration","-of","json"]),s=new Array;n.stdout.on("data",(e=>{s.push(e)})),n.on("exit",(()=>{let e=Buffer.concat(s).toString(),r=dt.as(JSON.parse(e)).streams.map((e=>({offset_ms:Math.round(1e3*Number.parseFloat(e.start_time)),duration_ms:Math.round(1e3*Number.parseFloat(e.duration))})));t(r)}))}))}))}(e),s=yield ut(e,t),i=n[t];return function(e){let t=new Array;for(let r=0;r+1<e.length;r++)t.push({offset_ms:e[r],duration_ms:e[r+1]-e[r]});return t}([...function(e,t){let r=-1/0,n=new Array;for(let s=1;s<e.length;s++)e[s]-r>t&&(r=e[s-1],n.push(r));return n}([...s,i.duration_ms],r),i.duration_ms])}))}(r.path,0,1e4),mt[e]=t}return t}))}function yt(e){return null==e}function St(e){return null!=e}function vt(e){return st(i.parse(e.url||"/",!0).query.token)}let _t=(new class{constructor(){this.routes=new Array}registerRoute(e){return this.routes.push(e),this}route(e,t){for(let r of this.routes)if(r.handlesRequest(e))return r.handleRequest(e,t);t.writeHead(400),t.end("{}")}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let r=/^[/]api[/]auth[/][?]token[=]([0-9a-f]{64})/.exec(e.url);if(null===r)throw new Error;let n=r[1],s={};try{return st(n),t.writeHead(200),t.end(JSON.stringify(s))}catch(e){}return t.writeHead(401),t.end(JSON.stringify(s))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]auth[/][?]token[=]([0-9a-f]{64})/.test(e.url)}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let r="";e.on("data",(e=>{r+=e})).on("end",(()=>{try{let e=JSON.parse(r);if(null==e||e.constructor!==Object)throw new Error;if(null==e.username||e.username.constructor!==String)throw new Error;if(null==e.password||e.password.constructor!==String)throw new Error;let n=e,s={token:nt(n.username,n.password)};t.writeHead(200),t.end(JSON.stringify(s))}catch(e){t.writeHead(400),t.end(JSON.stringify({error:e.message}))}}))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]auth[/]/.test(e.url)}}).registerRoute(new class{constructor(){}handleRequest(e,t){let r=vt(e);if(void 0===e.url)throw new Error;let n=/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]/.exec(e.url);if(null===n)throw new Error;let s=n[1],i=re[s];if(void 0===i)throw new Error;let o=Ie(s).map((e=>{let t=rt(r,e.file_id);return Object.assign(Object.assign({},e),{streamed:t})})),a=Object.assign(Object.assign({},i),{movie_parts:o});t.writeHead(200),t.end(JSON.stringify(a))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]video[/]movies[/]([0-9a-f]{32})[/]/.test(e.url)}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let r=Date.now(),n=0,s=(vt(e),{movies:$.video.movies.map((e=>{n-=Date.now();let t=Ie(e.movie_id).map((e=>Object.assign(Object.assign({},e),{streamed:null})));return n+=Date.now(),Object.assign(Object.assign({},e),{movie_parts:t})}))});console.log(n,Date.now()-r),t.writeHead(200),t.end(JSON.stringify(s))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]video[/]movies[/]/.test(e.url)}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let r=/^\/api\/audio\/artists\/([0-9a-f]{32})\//.exec(e.url);if(null===r)throw new Error;let n=r[1],s=K[n];if(void 0===s)throw new Error;let i=$.audio.album_artists.filter((e=>e.artist_id===n)).map((e=>{let t=Y[e.album_id],r=$.audio.discs.filter((e=>e.album_id===t.album_id)).map((e=>{let t=$.audio.tracks.filter((t=>t.disc_id===e.disc_id)).map((e=>{let t=$e(e.track_id);return Object.assign(Object.assign({},e),{artists:t})}));return Object.assign(Object.assign({},e),{tracks:t})})),n=Fe(e.album_id);return Object.assign(Object.assign({},t),{artists:n,discs:r})})),o=function(e){let t=Ue.lookup(e).map((e=>fe(V,e.track_id))).map((e=>e.disc_id));t=Array.from(new Set(t));let r=t.map((e=>fe(X,e))).map((e=>e.album_id));r=Array.from(new Set(r));let n=new Array;for(let t of r)null==ke.lookup(t).find((t=>t.artist_id===e))&&n.push(t);return n}(n).map((e=>{let t=qe(e),r=$.audio.discs.filter((e=>e.album_id===t.album_id)).map((e=>{let t=$.audio.tracks.filter((t=>t.disc_id===e.disc_id)).map((e=>{let t=$e(e.track_id);return Object.assign(Object.assign({},e),{artists:t})}));return Object.assign(Object.assign({},e),{tracks:t})})),n=Fe(e);return Object.assign(Object.assign({},t),{artists:n,discs:r})})),a=Object.assign(Object.assign({},s),{albums:i,appearances:o});t.writeHead(200),t.end(JSON.stringify(a))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^\/api\/audio\/artists\/([0-9a-f]{32})\//.test(e.url)}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let r={artists:$.audio.artists.map((e=>{let t=Re.lookup(e.artist_id).map((e=>{let t=De.lookup(e.album_id),r=Fe(t.album_id),n=Ce.lookup(t.album_id).map((e=>{let t=Le.lookup(e.disc_id).map((e=>{let t=$e(e.track_id);return Object.assign(Object.assign({},e),{artists:t})}));return Object.assign(Object.assign({},e),{tracks:t})}));return Object.assign(Object.assign({},t),{artists:r,discs:n})}));return Object.assign(Object.assign({},e),{albums:t,appearances:[]})}))};t.writeHead(200),t.end(JSON.stringify(r))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^\/api\/audio\/artists\//.test(e.url)}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let r=/^\/api\/audio\/albums\/([0-9a-f]{32})\//.exec(e.url);if(null===r)throw new Error;let n=r[1],s=Y[n];if(void 0===s)throw new Error;let i=$.audio.discs.filter((e=>e.album_id===n)).map((e=>{let t=$.audio.tracks.filter((t=>t.disc_id===e.disc_id)).map((e=>{let t=$e(e.track_id);return Object.assign(Object.assign({},e),{artists:t})}));return Object.assign(Object.assign({},e),{tracks:t})})),o=Fe(n),a=Object.assign(Object.assign({},s),{artists:o,discs:i});t.writeHead(200),t.end(JSON.stringify(a))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^\/api\/audio\/albums\/([0-9a-f]{32})\//.test(e.url)}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let r={albums:$.audio.albums.map((e=>{let t=Fe(e.album_id),r=Ce.lookup(e.album_id).map((e=>{let t=Le.lookup(e.disc_id).map((e=>{let t=$e(e.track_id);return Object.assign(Object.assign({},e),{artists:t})}));return Object.assign(Object.assign({},e),{tracks:t})}));return Object.assign(Object.assign({},e),{artists:t,discs:r})}))};t.writeHead(200),t.end(JSON.stringify(r))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^\/api\/audio\/albums\//.test(e.url)}}).registerRoute(new class{constructor(){}handleRequest(e,t){let r=vt(e);if(void 0===e.url)throw new Error;let n=/^[/]api[/]video[/]episodes[/]([0-9a-f]{32})[/]/.exec(e.url);if(null===n)throw new Error;let s=n[1],i=Z[s];if(void 0===i)throw new Error;let o=Me(i.file_id),a=rt(r,i.file_id),l=Object.assign(Object.assign({},i),{streamed:a,subtitles:o});t.writeHead(200),t.end(JSON.stringify(l))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]video[/]episodes[/]([0-9a-f]{32})[/]/.test(e.url)}}).registerRoute(new class{constructor(){}handleRequest(e,t){let r=vt(e);if(void 0===e.url)throw new Error;let n=/^[/]api[/]video[/]shows[/]([0-9a-f]{32})[/]/.exec(e.url);if(null===n)throw new Error;let s=n[1],i=Q[s];if(void 0===i)throw new Error;let o=je(s).map((e=>{let t=e.episodes.map((e=>{let t=Me(e.file_id),n=rt(r,e.file_id);return Object.assign(Object.assign({},e),{streamed:n,subtitles:t})}));return Object.assign(Object.assign({},e),{episodes:t})})),a=Object.assign(Object.assign({},i),{seasons:o});t.writeHead(200),t.end(JSON.stringify(a))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]video[/]shows[/]([0-9a-f]{32})[/]/.test(e.url)}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(vt(e),void 0===e.url)throw new Error;let r={shows:$.video.shows.map((e=>{let t=je(e.show_id).map((e=>{let t=e.episodes.map((e=>{let t=Me(e.file_id);return Object.assign(Object.assign({},e),{streamed:null,subtitles:t})}));return Object.assign(Object.assign({},e),{episodes:t})}));return Object.assign(Object.assign({},e),{seasons:t})})).map((e=>{let t=(r=e.show_id,me.lookup(r).map((e=>Se.lookup(e.video_genre_id))));var r;return Object.assign(Object.assign({},e),{genres:t})}))};t.writeHead(200),t.end(JSON.stringify(r))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]video[/]shows[/]/.test(e.url)}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let r=/^[/]api[/]audio[/]playlists[/]([0-9a-f]{32})[/]/.exec(e.url);if(null===r)throw new Error;let n=r[1],s=ae[n];if(void 0===s)throw new Error;let i={playlist_id:s.audiolist_id,title:s.title},o=Pe.lookup(i.playlist_id).map((e=>{let t=Be.lookup(e.track_id),r=He.lookup(t.disc_id),n=De.lookup(r.album_id);return{playlist:i,number:e.number,track:{track_id:t.track_id,title:t.title,disc:{disc_id:r.disc_id,album:{album_id:n.album_id,title:n.title,year:n.year,artists:Fe(n.album_id),artwork:yt(n.cover_file_id)?void 0:{file_id:n.cover_file_id,mime:"image/jpeg",height:1080,width:1080}},number:r.number},artists:$e(t.track_id),file:{file_id:t.file_id,mime:"audio/mp4",duration_ms:t.duration},number:t.number}}})),a=Object.assign(Object.assign({},i),{items:o});t.writeHead(200),t.end(JSON.stringify(a))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]audio[/]playlists[/]([0-9a-f]{32})[/]/.test(e.url)}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let r={audiolists:F.audiolists};t.writeHead(200),t.end(JSON.stringify(r))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]audio[/]playlists[/]/.test(e.url)}}).registerRoute(new class{constructor(){}handleRequest(e,t){if(void 0===e.url)throw new Error;let r="";e.on("data",(e=>{r+=e})).on("end",(()=>{try{let e=JSON.parse(r);if(null==e||e.constructor!==Object)throw new Error;let n=e.query;if(null==n||n.constructor!==String)throw new Error;let s={cues:function(e){let t=B(e).map((e=>{let t=de.get(e);return void 0!==t?t:new Set})).filter((e=>e.size>0)),r=new Array;if(t.length>0)e:for(let e of t[0]){for(let r=1;r<t.length;r++)if(!t[r].has(e))continue e;if(!(r.length<10))break e;r.push(e)}return r}(n).map((e=>ie[e])).map((e=>{let t=se[e.subtitle_id],r=Ne(t.video_file_id);if(b.is(r)){let n=r,s=re[n.movie_id];return Object.assign(Object.assign({},e),{subtitle:Object.assign(Object.assign({},t),{episode:void 0,movie_part:Object.assign(Object.assign({},n),{movie:s})})})}if(_.is(r)){let n=r,s=ee[n.season_id],i=Q[s.show_id];return Object.assign(Object.assign({},e),{subtitle:Object.assign(Object.assign({},t),{episode:Object.assign(Object.assign({},n),{season:Object.assign(Object.assign({},s),{show:i})}),movie_part:void 0})})}throw""}))};t.writeHead(200),t.end(JSON.stringify(s))}catch(e){t.writeHead(400),t.end(JSON.stringify({error:e.message}))}}))}handlesRequest(e){return"POST"===e.method&&void 0!==e.url&&/^[/]api[/]video[/]cues[/]/.test(e.url)}}).registerRoute(new class{handleRequest(e,t){let r=/^[/]api[/]video[/]channels[/]([0-9]+)[/]/.exec(e.url||"/");if(null==r)throw"";vt(e);let n={segments:(s=Number.parseInt(r[1]),gt(s).map((e=>{let t=Ne(e.file_id);if(_.is(t)){let e=Ve(t.episode_id),r=Me(e.file_id);return{episode:Object.assign(Object.assign({},e),{subtitles:r})}}throw"Unreachable!"})))};var s;t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){return"POST"===e.method&&/^[/]api[/]video[/]channels[/]([0-9]+)[/]/.test(e.url||"/")}}).registerRoute(new class{handleRequest(e,t){let r=new Array;for(let e=0;e<100;e++)r.push(ht(e));let n={channels:r};t.writeHead(200),t.end(JSON.stringify(n))}handlesRequest(e){return"POST"===e.method&&/^[/]api[/]video[/]channels[/]/.test(e.url||"/")}}).registerRoute(new class{handleRequest(e,t){vt(e);let r=/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]/.exec(e.url||"/");if(null==r)throw"";let n=r[1],s=ne[n],i=function(e){return be.lookup(e).map((e=>Je(e.movie_id)))}(n).map((e=>{let t=Ie(e.movie_id).map((e=>{let t=Me(e.file_id);return Object.assign(Object.assign({},e),{streamed:null,subtitles:t})}));return Object.assign(Object.assign({},e),{movie_parts:t})})),o=function(e){return ye.lookup(e).map((e=>We(e.show_id)))}(n).map((e=>{let t=je(e.show_id).map((e=>{let t=e.episodes.map((e=>{let t=Me(e.file_id);return Object.assign(Object.assign({},e),{streamed:null,subtitles:t})}));return Object.assign(Object.assign({},e),{episodes:t})}));return Object.assign(Object.assign({},e),{seasons:t})})),a={genre:Object.assign(Object.assign({},s),{movies:i,shows:o})};t.writeHead(200),t.end(JSON.stringify(a))}handlesRequest(e){return"POST"===e.method&&/^[/]api[/]video[/]genres[/]([0-9a-f]{32})[/]/.test(e.url||"/")}}).registerRoute(new class{handleRequest(e,t){let r={genres:$.video.genres.map((e=>Object.assign({},e)))};t.writeHead(200),t.end(JSON.stringify(r))}handlesRequest(e){return"POST"===e.method&&/^[/]api[/]video[/]genres[/]/.test(e.url||"/")}}).registerRoute(new class{handleRequest(e,t){let r=/^[/]api[/]search[/](.*)/.exec(e.url||"/");if(null==r)throw"";let n=(i=decodeURIComponent(r[1]),o=10,{artistIds:Ye.search(i,o),albumIds:Ke.search(i,o),trackIds:Qe.search(i,o),showIds:Ze.search(i,o),movieIds:et.search(i,o),episodeIds:tt.search(i,o)}),s={artists:n.artistIds.map(Ge),albums:n.albumIds.map(qe),tracks:n.trackIds.map(ze),shows:n.showIds.map(We),movies:n.movieIds.map(Je),episodes:n.episodeIds.map(Ve)};var i,o;t.writeHead(200),t.end(JSON.stringify(s))}handlesRequest(e){return"POST"===e.method&&/^[/]api[/]search[/]/.test(e.url||"/")}}).registerRoute(new class{handleRequest(e,t){let r={tokens:(n=vt(e),q.tokens.filter((e=>e.username===n)))};var n;t.writeHead(200),t.end(JSON.stringify(r))}handlesRequest(e){return"POST"===e.method&&/^[/]api[/]tokens[/]/.test(e.url||"/")}});function wt(t){let r=o.randomBytes(16).toString("hex"),n=[".","private","jobs",r];return e.mkdirSync(n.join("/"),{recursive:!0}),t(n,r)}function Ot(t,r){e.mkdirSync(r.slice(0,-1).join("/"),{recursive:!0}),e.renameSync(t.join("/"),r.join("/"))}function Et(t){let r=e.statSync(t);r.isDirectory()?(e.readdirSync(t).map((e=>t+"/"+e)).forEach(Et),e.rmdirSync(t)):r.isFile()&&e.unlinkSync(t)}class Tt{constructor(e){this.state=e,this.observers=new Array}addObserver(e){let t=new Tt(e(this.state));return this.observers.push((r=>{t.updateState(e(r))})),t.addObserver.bind(t)}getState(){return this.state}updateState(e){if(e!==this.state){this.state=e;for(let e of this.observers)e(this.state)}}}class jt{constructor(e){this.state=e,this.observers=new Array}addObserver(e){var t;this.observers.push(e),null===(t=e.onupdate)||void 0===t||t.call(e,this.state)}compute(e){let t=new Tt(e(this.state));return this.observers.push({onupdate(r){t.updateState(e(r))}}),t.addObserver.bind(t)}getState(){return this.state}append(e){var t,r;this.state.push(e);for(let n of this.observers)null===(t=n.onappend)||void 0===t||t.call(n,e),null===(r=n.onupdate)||void 0===r||r.call(n,this.state)}splice(e){var t,r;if(e<0||e>=this.state.length)throw`Expected an index of at most ${this.state.length}, got ${e}!`;let n=this.state[e];this.state.splice(e,1);for(let s of this.observers)null===(t=s.onsplice)||void 0===t||t.call(s,n,e),null===(r=s.onupdate)||void 0===r||r.call(s,this.state)}update(e){for(let e=this.state.length-1;e>=0;e--)this.splice(e);for(let t of e)this.append(t)}}const It=a.l8.Object.of({artist_id:a.l8.String,title:a.l8.String}),Nt=a.l8.Intersection.of(a.l8.Reference.of((()=>It)),a.l8.Object.of({albums:a.l8.Array.of(a.l8.Reference.of((()=>Rt)))})),kt=a.l8.Object.of({album_id:a.l8.String,title:a.l8.String,year:a.l8.Number,artists:a.l8.Array.of(a.l8.Reference.of((()=>It))),artwork:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>Yt)))}),Rt=a.l8.Intersection.of(a.l8.Reference.of((()=>kt)),a.l8.Object.of({discs:a.l8.Array.of(a.l8.Reference.of((()=>Ut)))})),xt=a.l8.Object.of({disc_id:a.l8.String,album:a.l8.Reference.of((()=>kt)),number:a.l8.Number}),Ut=a.l8.Intersection.of(a.l8.Reference.of((()=>xt)),a.l8.Object.of({tracks:a.l8.Array.of(a.l8.Reference.of((()=>Ct)))})),At=a.l8.Object.of({track_id:a.l8.String,title:a.l8.String,disc:a.l8.Reference.of((()=>xt)),artists:a.l8.Array.of(a.l8.Reference.of((()=>It))),file:a.l8.Reference.of((()=>Xt)),number:a.l8.Number,last_stream_date:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),Ct=a.l8.Intersection.of(a.l8.Reference.of((()=>At)),a.l8.Object.of({})),Lt=a.l8.Object.of({playlist_id:a.l8.String,title:a.l8.String}),Dt=a.l8.Intersection.of(a.l8.Reference.of((()=>Lt)),a.l8.Object.of({items:a.l8.Array.of(a.l8.Reference.of((()=>Bt)))})),Pt=a.l8.Object.of({number:a.l8.Number,playlist:a.l8.Reference.of((()=>Lt)),track:a.l8.Reference.of((()=>Ct))}),Bt=a.l8.Intersection.of(a.l8.Reference.of((()=>Pt)),a.l8.Object.of({})),Ht=a.l8.Object.of({genre_id:a.l8.String,title:a.l8.String}),Mt=(a.l8.Intersection.of(a.l8.Reference.of((()=>Ht)),a.l8.Object.of({})),a.l8.Object.of({movie_id:a.l8.String,title:a.l8.String,year:a.l8.Number,summary:a.l8.String,artwork:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>Yt))),file:a.l8.Reference.of((()=>Qt)),subtitles:a.l8.Array.of(a.l8.Reference.of((()=>Kt))),last_stream_date:a.l8.Union.of(a.l8.Undefined,a.l8.Number)})),Gt=a.l8.Intersection.of(a.l8.Reference.of((()=>Mt)),a.l8.Object.of({})),Ft=a.l8.Object.of({show_id:a.l8.String,title:a.l8.String,artwork:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>Yt)))}),qt=a.l8.Intersection.of(a.l8.Reference.of((()=>Ft)),a.l8.Object.of({seasons:a.l8.Array.of(a.l8.Reference.of((()=>zt)))})),$t=a.l8.Object.of({season_id:a.l8.String,number:a.l8.Number,show:a.l8.Reference.of((()=>Ft))}),zt=a.l8.Intersection.of(a.l8.Reference.of((()=>$t)),a.l8.Object.of({episodes:a.l8.Array.of(a.l8.Reference.of((()=>Wt)))})),Jt=a.l8.Object.of({episode_id:a.l8.String,title:a.l8.String,summary:a.l8.String,number:a.l8.Number,file:a.l8.Reference.of((()=>Qt)),subtitles:a.l8.Array.of(a.l8.Reference.of((()=>Kt))),season:a.l8.Reference.of((()=>$t)),year:a.l8.Union.of(a.l8.Undefined,a.l8.Number),last_stream_date:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),Wt=a.l8.Intersection.of(a.l8.Reference.of((()=>Jt)),a.l8.Object.of({})),Vt=a.l8.Object.of({file_id:a.l8.String,mime:a.l8.String}),Xt=a.l8.Intersection.of(a.l8.Reference.of((()=>Vt)),a.l8.Object.of({duration_ms:a.l8.Number})),Yt=a.l8.Intersection.of(a.l8.Reference.of((()=>Vt)),a.l8.Object.of({height:a.l8.Number,width:a.l8.Number})),Kt=a.l8.Intersection.of(a.l8.Reference.of((()=>Vt)),a.l8.Object.of({language:a.l8.Union.of(a.l8.Undefined,a.l8.String)})),Qt=a.l8.Intersection.of(a.l8.Reference.of((()=>Vt)),a.l8.Object.of({duration_ms:a.l8.Number})),Zt=a.l8.Reference.of((()=>Rt)),er=a.l8.Reference.of((()=>Nt)),tr=a.l8.Reference.of((()=>Ct)),rr=a.l8.Reference.of((()=>Dt)),nr=a.l8.Reference.of((()=>Gt)),sr=a.l8.Reference.of((()=>qt)),ir=a.l8.Reference.of((()=>zt)),or=a.l8.Reference.of((()=>Wt)),ar=a.l8.Union.of(a.l8.Reference.of((()=>Zt)),a.l8.Reference.of((()=>er)),a.l8.Reference.of((()=>tr)),a.l8.Reference.of((()=>rr)),a.l8.Reference.of((()=>nr)),a.l8.Reference.of((()=>sr)),a.l8.Reference.of((()=>ir)),a.l8.Reference.of((()=>or))),lr=(a.l8.Union.of(a.l8.Reference.of((()=>tr)),a.l8.Reference.of((()=>nr)),a.l8.Reference.of((()=>or))),a.l8.Object.of({id:a.l8.String,type:a.l8.String,name:a.l8.String})),dr=(a.l8.Object.of({context:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>ar))),device:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>lr))),index:a.l8.Union.of(a.l8.Undefined,a.l8.Number),playback:a.l8.Boolean,progress:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),{SetContext:a.l8.Object.of({context:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>ar)))}),SetDevice:a.l8.Object.of({device:a.l8.Union.of(a.l8.Undefined,a.l8.Reference.of((()=>lr)))}),SetDevices:a.l8.Object.of({devices:a.l8.Array.of(a.l8.Reference.of((()=>lr)))}),SetIndex:a.l8.Object.of({index:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),SetLocalDevice:a.l8.Object.of({device:a.l8.Reference.of((()=>lr))}),SetPlayback:a.l8.Object.of({playback:a.l8.Boolean}),SetProgress:a.l8.Object.of({progress:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),SetToken:a.l8.Object.of({token:a.l8.Union.of(a.l8.Undefined,a.l8.String)})});var cr=r(978),ur=r(611);class fr{constructor(e,t,r){this.nextConnectionAttemptDelayFactor=2+Math.random(),this.nextConnectionAttemptDelay=2e3,this.router=new cr.routing.NamespacedMessageRouter,this.serializer=new a.m7.MessageSerializer(r),this.url=e,this.factory=t,this.socket=t(e),this.socket.addEventListener("close",this.onClose.bind(this)),this.socket.addEventListener("error",this.onError.bind(this)),this.socket.addEventListener("message",this.onMessage.bind(this)),this.socket.addEventListener("open",this.onOpen.bind(this))}onClose(e){this.router.route("sys","disconnect",{})}onError(e){setTimeout((()=>{this.socket=this.factory(this.url),this.socket.addEventListener("close",this.onClose.bind(this)),this.socket.addEventListener("error",this.onError.bind(this)),this.socket.addEventListener("message",this.onMessage.bind(this)),this.socket.addEventListener("open",this.onOpen.bind(this))}),this.nextConnectionAttemptDelay),this.nextConnectionAttemptDelay=Math.round(this.nextConnectionAttemptDelay*this.nextConnectionAttemptDelayFactor)}onMessage(e){let t=e.data;this.serializer.deserialize(t,((e,t)=>{this.router.route("sys","message",{type:e,data:t}),this.router.route("app",e,t)}))}onOpen(e){this.nextConnectionAttemptDelay=2e3,this.router.route("sys","connect",{})}addEventListener(e,t,r){this.router.addObserver(e,t,r)}close(){this.socket.close()}removeEventListener(e,t,r){this.router.addObserver(e,t,r)}send(e,t){if(this.socket.readyState===ur.ReadyState.OPEN)this.socket.send(this.serializer.serialize(e,t));else{let r=()=>{this.socket.removeEventListener("open",r),this.socket.send(this.serializer.serialize(e,t))};this.socket.addEventListener("open",r)}}}class pr{constructor(e,t=(e=>new WebSocket(e))){this.estimatedProgress=new Tt(void 0),this.estimatedProgressTimestamp=new Tt(void 0),this.token=new Tt(void 0),this.localDevice=new Tt(void 0),this.devices=new jt(new Array),this.device=new Tt(void 0),this.isDeviceLocal=new Tt(!1),this.isDeviceRemote=new Tt(!1),this.context=new Tt(void 0),this.contextPath=new Tt(void 0),this.flattenedContext=new Tt(void 0),this.lastIndex=new Tt(void 0),this.lastEntry=new Tt(void 0),this.lastLocalEntry=new Tt(void 0),this.currentIndex=new Tt(void 0),this.currentEntry=new Tt(void 0),this.currentLocalEntry=new Tt(void 0),this.nextIndex=new Tt(void 0),this.nextEntry=new Tt(void 0),this.nextLocalEntry=new Tt(void 0),this.playback=new Tt(!1),this.progress=new Tt(void 0),this.localPlayback=new Tt(!1),this.canPlayLast=new Tt(!1),this.canPlayCurrent=new Tt(!1),this.canPlayNext=new Tt(!1),this.isCurrentEntryVideo=new Tt(!1),this.tsc=new fr(e,t,dr),this.context.addObserver((e=>{if(St(e))if(Zt.is(e)){let t=[],r=e;for(let e of r.discs)t.push(...e.tracks);this.flattenedContext.updateState(t)}else if(er.is(e)){let t=[],r=e;for(let e of r.albums)for(let r of e.discs)t.push(...r.tracks);this.flattenedContext.updateState(t)}else if(or.is(e)){let t=[],r=e;t.push(r),this.flattenedContext.updateState(t)}else if(nr.is(e)){let t=[],r=e;t.push(r),this.flattenedContext.updateState(t)}else if(rr.is(e)){let t=[],r=e;for(let e of r.items)t.push(e.track);this.flattenedContext.updateState(t)}else if(ir.is(e)){let t=[],r=e;t.push(...r.episodes),this.flattenedContext.updateState(t)}else if(sr.is(e)){let t=[],r=e;for(let e of r.seasons)t.push(...e.episodes);this.flattenedContext.updateState(t)}else{if(!tr.is(e))throw"Expected code to be unreachable!";{let t=[],r=e;t.push(r),this.flattenedContext.updateState(t)}}}));{let e=()=>{let e=this.context.getState(),t=this.currentIndex.getState();if(St(e)&&St(t)){if(Zt.is(e)){let r=0,n=t,s=e.discs;for(let e=0;e<s.length;e++){let t=s[e].tracks.length;if(!(n>=t))break;r+=1,n-=t}return this.contextPath.updateState([e.album_id,e.discs[r].disc_id,e.discs[r].tracks[n].track_id])}if(er.is(e)){let r=0,n=0,s=t,i=e.albums;e:for(let e=0;e<i.length;e++){let t=i[e].discs;for(let e=0;e<t.length;e++){let r=t[e].tracks.length;if(!(s>=r))break e;n+=1,s-=r}r+=1,n=0}return this.contextPath.updateState([e.artist_id,e.albums[r].album_id,e.albums[r].discs[n].disc_id,e.albums[r].discs[n].tracks[s].track_id])}if(or.is(e))return this.contextPath.updateState([e.episode_id]);if(nr.is(e))return this.contextPath.updateState([e.movie_id]);if(rr.is(e)){let r=t;return this.contextPath.updateState([e.playlist_id,e.items[r].track.track_id])}if(sr.is(e)){let r=0,n=t,s=e.seasons;for(let e=0;e<s.length;e++){let t=s[e].episodes.length;if(!(n>=t))break;r+=1,n-=t}return this.contextPath.updateState([e.show_id,e.seasons[r].season_id,e.seasons[r].episodes[n].episode_id])}if(ir.is(e)){let r=t;return this.contextPath.updateState([e.season_id,e.episodes[r].episode_id])}if(tr.is(e))return this.contextPath.updateState([e.track_id]);throw"Expected code to be unreachable!"}this.contextPath.updateState(void 0)};this.context.addObserver(e),this.currentIndex.addObserver(e)}this.lastEntry.addObserver((e=>{this.canPlayLast.updateState(St(e))})),this.currentEntry.addObserver((e=>{this.canPlayCurrent.updateState(St(e))})),this.nextEntry.addObserver((e=>{this.canPlayNext.updateState(St(e))})),this.progress.addObserver((e=>{this.estimatedProgress.updateState(e),this.estimatedProgressTimestamp.updateState(Date.now())})),this.playback.addObserver((e=>{let t=this.estimatedProgress.getState(),r=this.estimatedProgressTimestamp.getState(),n=Date.now();e||St(t)&&St(r)&&this.estimatedProgress.updateState(t+(n-r)/1e3),this.estimatedProgressTimestamp.updateState(n)})),this.estimatedProgress.addObserver((e=>{console.log("Estimated progress to "+(null!=e?e:0))}));{let e=()=>{let e=this.playback.getState(),t=this.isDeviceLocal.getState();this.localPlayback.updateState(t&&e)};this.playback.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.lastEntry.getState(),t=this.isDeviceLocal.getState();this.lastLocalEntry.updateState(t?e:void 0)};this.lastEntry.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.currentEntry.getState(),t=this.isDeviceLocal.getState();this.currentLocalEntry.updateState(t?e:void 0)};this.currentEntry.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.nextEntry.getState(),t=this.isDeviceLocal.getState();this.nextLocalEntry.updateState(t?e:void 0)};this.nextEntry.addObserver(e),this.isDeviceLocal.addObserver(e)}{let e=()=>{let e=this.localDevice.getState(),t=this.device.getState();return St(e)&&St(t)&&e.id===t.id?this.isDeviceLocal.updateState(!0):this.isDeviceLocal.updateState(!1)};this.localDevice.addObserver(e),this.device.addObserver(e)}{let e=()=>{let e=this.localDevice.getState(),t=this.device.getState();return St(e)&&St(t)&&e.id!==t.id?this.isDeviceRemote.updateState(!0):this.isDeviceRemote.updateState(!1)};this.localDevice.addObserver(e),this.device.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.currentIndex.getState();if(St(e)&&St(t)){let r=t-1;if(r>=0&&r<e.length)return this.lastIndex.updateState(r)}return this.lastIndex.updateState(void 0)};this.flattenedContext.addObserver(e),this.currentIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.currentIndex.getState();if(St(e)&&St(t)){let r=t+1;if(r>=0&&r<e.length)return this.nextIndex.updateState(r)}return this.nextIndex.updateState(void 0)};this.flattenedContext.addObserver(e),this.currentIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.lastIndex.getState();return St(e)&&St(t)?this.lastEntry.updateState(e[t]):this.lastEntry.updateState(void 0)};this.flattenedContext.addObserver(e),this.lastIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.currentIndex.getState();return St(e)&&St(t)&&t>=0&&t+0<e.length?this.currentEntry.updateState(e[t+0]):this.currentEntry.updateState(void 0)};this.flattenedContext.addObserver(e),this.currentIndex.addObserver(e)}{let e=()=>{let e=this.flattenedContext.getState(),t=this.nextIndex.getState();return St(e)&&St(t)?this.nextEntry.updateState(e[t]):this.nextEntry.updateState(void 0)};this.flattenedContext.addObserver(e),this.nextIndex.addObserver(e)}this.token.addObserver((e=>{this.tsc.send("SetToken",{token:e})})),this.tsc.addEventListener("app","SetLocalDevice",(e=>{this.localDevice.updateState(e.device)})),this.tsc.addEventListener("app","SetDevices",(e=>{this.devices.update(e.devices)})),this.tsc.addEventListener("app","SetContext",(e=>{this.context.updateState(e.context)})),this.tsc.addEventListener("app","SetDevice",(e=>{this.device.updateState(e.device)})),this.tsc.addEventListener("app","SetIndex",(e=>{this.currentIndex.updateState(e.index)})),this.tsc.addEventListener("app","SetPlayback",(e=>{this.playback.updateState(e.playback)})),this.tsc.addEventListener("app","SetProgress",(e=>{this.progress.updateState(e.progress)})),this.tsc.addEventListener("app","SetToken",(e=>{this.token.updateState(e.token)}))}play(e,t){this.tsc.send("SetContext",{context:e}),this.tsc.send("SetIndex",{index:t}),this.resume()}authenticate(e){this.tsc.send("SetToken",{token:e})}close(){this.tsc.close()}last(){let e=this.lastIndex.getState();St(e)&&(this.currentIndex.updateState(e),this.tsc.send("SetIndex",{index:e}))}next(){let e=this.nextIndex.getState();St(e)&&(this.currentIndex.updateState(e),this.tsc.send("SetIndex",{index:e}))}pause(){this.playback.updateState(!1),this.tsc.send("SetPlayback",{playback:!1})}playAlbum(e,t,r){let n=0;if(St(t)){let s=e.discs;if(t<0||t>=s.length)throw`Expected ${t} to be a number between 0 and ${s.length}!`;if(n+=s.slice(0,t).reduce(((e,t)=>e+t.tracks.length),0),St(r)){let e=s[t].tracks;if(r<0||r>=e.length)throw`Expected ${r} to be a number between 0 and ${e.length}!`;n+=r}}return this.play(e,n)}playArtist(e,t,r,n){let s=0;if(St(t)){let i=e.albums;if(t<0||t>=i.length)throw`Expected ${t} to be a number between 0 and ${i.length}!`;if(s+=i.slice(0,t).reduce(((e,t)=>e+t.discs.reduce(((e,t)=>e+t.tracks.length),0)),0),St(r)){let e=i[t].discs;if(r<0||r>=e.length)throw`Expected ${r} to be a number between 0 and ${e.length}!`;if(s+=e.slice(0,r).reduce(((e,t)=>e+t.tracks.length),0),St(n)){let t=e[r].tracks;if(n<0||n>=t.length)throw`Expected ${n} to be a number between 0 and ${t.length}!`;s+=n}}}return this.play(e,s)}playEpisode(e){this.play(e,0)}playMovie(e){this.play(e,0)}playPlaylist(e,t){let r=0;if(St(t)){let n=e.items;if(t<0||t>=n.length)throw`Expected ${t} to be a number between 0 and ${n.length}!`;r+=t}return this.play(e,r)}playSeason(e,t){let r=0;if(St(t)){let n=e.episodes;if(t<0||t>=n.length)throw`Expected ${t} to be a number between 0 and ${n.length}!`;r+=t}return this.play(e,r)}playShow(e,t,r){let n=0;if(St(t)){let s=e.seasons;if(t<0||t>=s.length)throw`Expected ${t} to be a number between 0 and ${s.length}!`;if(n+=s.slice(0,t).reduce(((e,t)=>e+t.episodes.length),0),St(r)){let e=s[t].episodes;if(r<0||r>=e.length)throw`Expected ${r} to be a number between 0 and ${e.length}!`;n+=r}}return this.play(e,n)}playTrack(e){this.play(e,0)}resume(){this.playback.updateState(!0),this.tsc.send("SetPlayback",{playback:!0})}seek(e){this.tsc.send("SetProgress",{progress:e})}toggle(){this.playback.getState()?this.pause():this.resume()}transfer(e){this.tsc.send("SetDevice",{device:e})}}var hr=r(545);class gr{constructor(e){this.router=new cr.routing.NamespacedMessageRouter,this.serializer=new a.m7.MessageSerializer(e),this.socket=new hr.u9,this.socket.addEventListener("connect",(e=>{let t=e.connection_id,r=e.connection_url;this.router.route("sys","connect",{connection_id:t,connection_url:r})})),this.socket.addEventListener("disconnect",(e=>{let t=e.connection_id,r=e.connection_url;this.router.route("sys","disconnect",{connection_id:t,connection_url:r})})),this.socket.addEventListener("message",(e=>{let t=e.connection_id,r=e.connection_url,n=e.buffer.toString();this.serializer.deserialize(n,((e,n)=>{this.router.route("sys","message",{connection_id:t,connection_url:r,type:e,data:n}),this.router.route("app",e,{connection_id:t,connection_url:r,data:n})}))}))}addEventListener(e,t,r){this.router.addObserver(e,t,r)}broadcast(e,t){let r=this.serializer.serialize(e,t);this.socket.broadcast(r)}close(e){this.socket.close(e)}getRequestHandler(){return this.socket.getRequestHandler()}removeEventListener(e,t,r){this.router.addObserver(e,t,r)}send(e,t,r){let n=this.serializer.serialize(e,r);for(let e of Array.isArray(t)?t:[t])try{this.socket.send(e,n)}catch(e){}}}function mr(e,t){var r;let n=null!==(r=e.query[t])&&void 0!==r?r:[];return Array.isArray(n)?n:[n]}function br(e,t){var r,n;let s=i.parse(t,!0);return{id:e,name:null!==(r=mr(s,"name").pop())&&void 0!==r?r:"",type:null!==(n=mr(s,"type").pop())&&void 0!==n?n:""}}var yr,Sr,vr,_r=r(16);function wr(e){if(e>Number.MAX_SAFE_INTEGER||e<Number.MIN_SAFE_INTEGER)throw`Expected a safe integer but got ${e}!`;return Number(e)}function Or(e,t){let r=e.buffer.length-e.offset;if(t>r)throw`Expected to read at most ${r} bytes but attempted to read ${t} bytes!`;let n=e.buffer.slice(e.offset,e.offset+t);return e.offset+=t,n}function Er(e){let t=Buffer.alloc(10);for(let r=0;r<10;r++){let n=e.buffer.readUInt8(e.offset);if(e.offset+=1,t[r]=n,0==(128&n)){if(r+1===10&&0!=(126&n))throw"Expected a varint of at most 64 bits!";let e=BigInt(0);for(let n=r;n>=0;n--)e=e<<BigInt(7)|BigInt(127&t[n]);let s=Buffer.alloc(8);return s.writeBigUInt64LE(e,0),s}}throw"Expected a varint of at most 10 bytes!"}function Tr(e){let t=e.readBigUInt64LE(0),r=Buffer.alloc(10);for(let e=0;e<10;e++){let n=t&BigInt(127);if(t>>=BigInt(7),!(t>0))return r.writeUInt8(0|wr(n),e),r.slice(0,e+1);r.writeUInt8(128|wr(n),e)}throw"Expected to serialize at most 10 bytes!"}function jr(e){let t=BigInt(e.field_number)<<BigInt(3)|BigInt(e.wire_type)&BigInt(7),r=Buffer.alloc(8);return r.writeBigUInt64LE(t,0),Tr(r)}function Ir(e){let t=function(e){let t=Er(e).readBigUInt64LE(0);return{field_number:wr(t>>BigInt(3)),wire_type:wr(t&BigInt(7))}}(e);if(t.wire_type===yr.VARINT)return{key:t,data:Er(e)};if(t.wire_type===yr.FIXED_64_BIT)return{key:t,data:Or(e,8)};if(t.wire_type===yr.LENGTH_DELIMITED)return{key:t,data:Or(e,wr(Er(e).readBigUInt64LE(0)))};if(t.wire_type===yr.START_GROUP)return{key:t,data:Buffer.alloc(0)};if(t.wire_type===yr.END_GROUP)return{key:t,data:Buffer.alloc(0)};if(t.wire_type===yr.FIXED_32_BIT)return{key:t,data:Or(e,4)};throw"Expected a recognized wire type!"}function Nr(e){if(e.key.wire_type===yr.VARINT)return Buffer.concat([jr(e.key),Tr(e.data)]);if(e.key.wire_type===yr.FIXED_64_BIT){if(8!==e.data.length)throw"Expected to serialize exactly 8 bytes!";return Buffer.concat([jr(e.key),e.data])}if(e.key.wire_type===yr.LENGTH_DELIMITED){let t=Buffer.alloc(8);return t.writeBigUInt64LE(BigInt(e.data.length)),Buffer.concat([jr(e.key),Tr(t),e.data])}if(e.key.wire_type===yr.START_GROUP){if(0!==e.data.length)throw"Expected to serialize exactly 0 bytes!";return Buffer.concat([jr(e.key),e.data])}if(e.key.wire_type===yr.END_GROUP){if(0!==e.data.length)throw"Expected to serialize exactly 0 bytes!";return Buffer.concat([jr(e.key),e.data])}if(e.key.wire_type===yr.FIXED_32_BIT){if(4!==e.data.length)throw"Expected to serialize exactly 4 bytes!";return Buffer.concat([jr(e.key),e.data])}throw"Expected a recognized wire type!"}function kr(e,t){let r=t.filter((t=>t.key.field_number===e));if(0===r.length)throw"Expected required field to be present!";return wr(r[r.length-1].data.readBigUInt64LE(0))}function Rr(e,t){return Nr({key:{field_number:e,wire_type:yr.VARINT},data:function(e){let t=Buffer.alloc(8);return t.writeBigUInt64LE(BigInt(e)),t}(t)})}function xr(e,t){let r=t.filter((t=>t.key.field_number===e));if(0===r.length)throw"Expected required field to be present!";return r[r.length-1].data.toString()}function Ur(e,t){return Nr({key:{field_number:e,wire_type:yr.LENGTH_DELIMITED},data:Buffer.from(t)})}function Ar(e,t){return null==t?Buffer.alloc(0):function(e,t){return Nr({key:{field_number:e,wire_type:yr.LENGTH_DELIMITED},data:t})}(e,t)}!function(e){e[e.VARINT=0]="VARINT",e[e.FIXED_64_BIT=1]="FIXED_64_BIT",e[e.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",e[e.START_GROUP=3]="START_GROUP",e[e.END_GROUP=4]="END_GROUP",e[e.FIXED_32_BIT=5]="FIXED_32_BIT"}(yr||(yr={})),function(e){e[e.CASTV2_1_0=0]="CASTV2_1_0"}(Sr||(Sr={})),function(e){e[e.STRING=0]="STRING",e[e.BINARY=1]="BINARY"}(vr||(vr={}));const Cr=require("dgram");var Lr=function(e,t,r,n){return new(r||(r=Promise))((function(s,i){function o(e){try{l(n.next(e))}catch(e){i(e)}}function a(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};let Dr={},Pr={},Br=(e,t)=>{let r=Pr[e];if(void 0!==r)for(let e of r)e(t);let n=Dr[e];void 0!==n&&Br(n,t)},Hr=(e,t,r)=>{Dr[t]=e,"A"===r&&Br(e,t)},Mr=(e,t)=>Lr(void 0,void 0,void 0,(function*(){let r=new Array;for(;;){let n=e.readUInt8(t);if(0===n){t+=1;break}if(n<64){t+=1;let s=e.slice(t,t+n);t+=n,r.push(s.toString("binary"));continue}if(n<192)throw new Error;let s=yield Mr(e,16383&e.readUInt16BE(t));r.push(s.value),t+=2;break}return{value:r.join("."),offset:t}})),Gr=(e,t)=>Lr(void 0,void 0,void 0,(function*(){let r=yield Mr(e,t);return t=r.offset,e.readUInt16BE(t),t+=2,e.readUInt16BE(t),t+=2,{value:r.value,offset:t}})),Fr=(e,t)=>Lr(void 0,void 0,void 0,(function*(){let r=yield Mr(e,t);t=r.offset;let n=e.readUInt16BE(t);t+=2,e.readUInt16BE(t),t+=2,e.readUInt32BE(t),t+=4;let s=e.readUInt16BE(t);t+=2;let i="";if(1===n&&(i=`${e[t+0]}.${e[t+1]}.${e[t+2]}.${e[t+3]}`,t+=4,Hr(r.value,i,"A")),12===n){let n=yield Mr(e,t);t=n.offset,i=n.value,Hr(r.value,i,"PTR")}if(16===n){let r=e.slice(t,t+s);t+=s,i=r.toString("binary")}if(33===n){e.readUInt16BE(t),t+=2,e.readUInt16BE(t),t+=2,e.readUInt16BE(t),t+=2;let n=yield Mr(e,t);t=n.offset,i=n.value,Hr(r.value,i,"SRV")}return{name:r.value,data:i,offset:t}}));const qr="224.0.0.251";let $r=Cr.createSocket({type:"udp4",reuseAddr:!0});$r.on("listening",(()=>{$r.setMulticastLoopback(!1),$r.addMembership(qr,"0.0.0.0")})),$r.on("message",((e,t)=>Lr(void 0,void 0,void 0,(function*(){try{yield(e=>Lr(void 0,void 0,void 0,(function*(){let t=0,r=e.slice(t,t+12);t+=12,r.readUInt16BE(0),r.readUInt16BE(2);let n=r.readUInt16BE(4),s=r.readUInt16BE(6),i=r.readUInt16BE(8),o=r.readUInt16BE(10),a=new Array;for(let r=0;r<n;r++){let r=yield Gr(e,t);a.push(r),t=r.offset}let l=new Array;for(let r=0;r<s;r++){let r=yield Fr(e,t);l.push(r),t=r.offset}let d=new Array;for(let r=0;r<i;r++){let r=yield Fr(e,t);d.push(r),t=r.offset}let c=new Array;for(let r=0;r<o;r++){let r=yield Fr(e,t);c.push(r),t=r.offset}})))(e)}catch(e){}})))),$r.bind(5353);const zr={CONNECT:a.l8.Object.of({type:a.l8.StringLiteral.of("CONNECT")}),CLOSE:a.l8.Object.of({type:a.l8.StringLiteral.of("CLOSE")})},Jr={PING:a.l8.Object.of({type:a.l8.StringLiteral.of("PING")}),PONG:a.l8.Object.of({type:a.l8.StringLiteral.of("PONG")})},Wr=a.l8.Object.of({url:a.l8.String,height:a.l8.Union.of(a.l8.Undefined,a.l8.Number),width:a.l8.Union.of(a.l8.Undefined,a.l8.Number)}),Vr=a.l8.Object.of({level:a.l8.Union.of(a.l8.Undefined,a.l8.Number),muted:a.l8.Union.of(a.l8.Undefined,a.l8.Boolean)}),Xr=a.l8.Object.of({contentId:a.l8.String,streamType:a.l8.Union.of(a.l8.StringLiteral.of("NONE"),a.l8.StringLiteral.of("BUFFERED"),a.l8.StringLiteral.of("LIVE")),contentType:a.l8.String,metadata:a.l8.Union.of(a.l8.Undefined,a.l8.Union.of(a.l8.Reference.of((()=>Yr)),a.l8.Reference.of((()=>Kr)),a.l8.Reference.of((()=>Qr)),a.l8.Reference.of((()=>Zr)),a.l8.Reference.of((()=>en)))),duration:a.l8.Union.of(a.l8.Undefined,a.l8.Number),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any)),tracks:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Union.of(a.l8.Object.of({trackId:a.l8.Number,type:a.l8.String}),a.l8.Object.of({trackId:a.l8.Number,type:a.l8.StringLiteral.of("TEXT"),trackType:a.l8.StringLiteral.of("TEXT"),trackContentId:a.l8.String,trackContentType:a.l8.String,subtype:a.l8.StringLiteral.of("SUBTITLES"),language:a.l8.String,name:a.l8.Union.of(a.l8.Undefined,a.l8.String),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}))))}),Yr=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(0),title:a.l8.Union.of(a.l8.Undefined,a.l8.String),subtitle:a.l8.Union.of(a.l8.Undefined,a.l8.String),images:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Reference.of((()=>Wr)))),releaseDate:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),Kr=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(1),title:a.l8.Union.of(a.l8.Undefined,a.l8.String),subtitle:a.l8.Union.of(a.l8.Undefined,a.l8.String),studio:a.l8.Union.of(a.l8.Undefined,a.l8.String),images:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Reference.of((()=>Wr)))),releaseDate:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),Qr=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(2),seriesTitle:a.l8.Union.of(a.l8.Undefined,a.l8.String),subtitle:a.l8.Union.of(a.l8.Undefined,a.l8.String),season:a.l8.Union.of(a.l8.Undefined,a.l8.Number),episode:a.l8.Union.of(a.l8.Undefined,a.l8.Number),images:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Reference.of((()=>Wr)))),originalAirDate:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),Zr=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(3),albumName:a.l8.Union.of(a.l8.Undefined,a.l8.String),title:a.l8.Union.of(a.l8.Undefined,a.l8.String),albumArtist:a.l8.Union.of(a.l8.Undefined,a.l8.String),artist:a.l8.Union.of(a.l8.Undefined,a.l8.String),composer:a.l8.Union.of(a.l8.Undefined,a.l8.String),trackNumber:a.l8.Union.of(a.l8.Undefined,a.l8.Number),discNumber:a.l8.Union.of(a.l8.Undefined,a.l8.Number),images:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Reference.of((()=>Wr)))),releaseDate:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),en=a.l8.Object.of({metadataType:a.l8.NumberLiteral.of(4),title:a.l8.Union.of(a.l8.Undefined,a.l8.String),artist:a.l8.Union.of(a.l8.Undefined,a.l8.String),location:a.l8.Union.of(a.l8.Undefined,a.l8.String),latitude:a.l8.Union.of(a.l8.Undefined,a.l8.Number),longitude:a.l8.Union.of(a.l8.Undefined,a.l8.Number),width:a.l8.Union.of(a.l8.Undefined,a.l8.Number),height:a.l8.Union.of(a.l8.Undefined,a.l8.Number),creationDateTime:a.l8.Union.of(a.l8.Undefined,a.l8.String)}),tn=a.l8.Object.of({mediaSessionId:a.l8.Number,media:a.l8.Union.of(a.l8.Undefined,a.l8.Union.of(a.l8.Reference.of((()=>Xr)),a.l8.Object.of({}))),playbackRate:a.l8.Number,playerState:a.l8.Union.of(a.l8.StringLiteral.of("IDLE"),a.l8.StringLiteral.of("PLAYING"),a.l8.StringLiteral.of("BUFFERING"),a.l8.StringLiteral.of("PAUSED")),idleReason:a.l8.Union.of(a.l8.Undefined,a.l8.Union.of(a.l8.StringLiteral.of("CANCELLED"),a.l8.StringLiteral.of("INTERRUPTED"),a.l8.StringLiteral.of("FINISHED"),a.l8.StringLiteral.of("ERROR"))),currentTime:a.l8.Number,supportedMediaCommands:a.l8.Number,volume:a.l8.Reference.of((()=>Vr)),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),rn=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("LOAD"),media:a.l8.Reference.of((()=>Xr)),autoplay:a.l8.Union.of(a.l8.Undefined,a.l8.Boolean),currentTime:a.l8.Union.of(a.l8.Undefined,a.l8.Number),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any)),activeTrackIds:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Number))}),nn=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("PAUSE"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),sn=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("SEEK"),resumeState:a.l8.Union.of(a.l8.Undefined,a.l8.Union.of(a.l8.StringLiteral.of("PLAYBACK_START"),a.l8.StringLiteral.of("PLAYBACK_PAUSE"))),currentTime:a.l8.Union.of(a.l8.Undefined,a.l8.Number),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),on=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("STOP"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),an=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("PLAY"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),ln=a.l8.Object.of({mediaSessionId:a.l8.Union.of(a.l8.Undefined,a.l8.Number),requestId:a.l8.Number,type:a.l8.StringLiteral.of("GET_STATUS"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),dn=a.l8.Object.of({mediaSessionId:a.l8.Number,requestId:a.l8.Number,type:a.l8.StringLiteral.of("VOLUME"),volume:a.l8.Reference.of((()=>Vr)),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),cn=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("INVALID_PLAYER_STATE"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),un=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("LOAD_FAILED"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),fn=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("LOAD_CANCELLED"),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),pn=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("INVALID_REQUEST"),reason:a.l8.Union.of(a.l8.StringLiteral.of("INVALID_COMMAND"),a.l8.StringLiteral.of("DUPLICATE_REQUESTID")),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),hn=a.l8.Object.of({requestId:a.l8.Number,type:a.l8.StringLiteral.of("MEDIA_STATUS"),status:a.l8.Array.of(a.l8.Reference.of((()=>tn))),customData:a.l8.Union.of(a.l8.Undefined,a.l8.Record.of(a.l8.Any))}),gn={LOAD:rn,PAUSE:nn,SEEK:sn,STOP:on,PLAY:an,GET_STATUS:ln,VOLUME:dn,INVALID_PLAYER_STATE:cn,LOAD_FAILED:un,LOAD_CANCELLED:fn,INVALID_REQUEST:pn,MEDIA_STATUS:hn},mn={LAUNCH:a.l8.Object.of({type:a.l8.StringLiteral.of("LAUNCH"),requestId:a.l8.Number,appId:a.l8.String}),STOP:a.l8.Object.of({type:a.l8.StringLiteral.of("STOP"),requestId:a.l8.Number,sessionId:a.l8.String}),GET_STATUS:a.l8.Object.of({type:a.l8.StringLiteral.of("GET_STATUS"),requestId:a.l8.Number}),GET_APP_AVAILABILITY:a.l8.Object.of({type:a.l8.StringLiteral.of("GET_APP_AVAILABILITY"),requestId:a.l8.Number,appId:a.l8.Array.of(a.l8.String)}),SET_VOLUME:a.l8.Object.of({type:a.l8.StringLiteral.of("SET_VOLUME"),requestId:a.l8.Number,volume:a.l8.Union.of(a.l8.Object.of({level:a.l8.Number}),a.l8.Object.of({muted:a.l8.Boolean}))}),RECEIVER_STATUS:a.l8.Object.of({type:a.l8.StringLiteral.of("RECEIVER_STATUS"),requestId:a.l8.Number,status:a.l8.Object.of({applications:a.l8.Union.of(a.l8.Undefined,a.l8.Array.of(a.l8.Object.of({appId:a.l8.String,displayName:a.l8.String,iconUrl:a.l8.String,isIdleScreen:a.l8.Boolean,launchedFromCloud:a.l8.Boolean,namespaces:a.l8.Array.of(a.l8.Object.of({name:a.l8.String})),sessionId:a.l8.String,statusText:a.l8.String,transportId:a.l8.String}))),userEq:a.l8.Object.of({}),volume:a.l8.Object.of({controlType:a.l8.String,level:a.l8.Number,muted:a.l8.Boolean,stepInterval:a.l8.Number})})})},bn={eng:{title:"English",iso639_1:"en",iso3166_1:"US"},swe:{title:"Swedish",iso639_1:"sv",iso3166_1:"SE"},jpn:{title:"Japanese",iso639_1:"ja",iso3166_1:"JP"}};const yn="https://ap.joelek.se";function Sn(e){var t;let r=null!==(t=bn[null!=e?e:"eng"])&&void 0!==t?t:bn.eng;return{language:[r.iso639_1,r.iso3166_1].join("-"),name:r.title}}const vn=new Set,_n=new Set;function wn(e){!function(e){if(!_n.has(e)){_n.add(e);for(let t of vn)try{e(t)}catch(e){}}}((r=>{return n=this,s=void 0,o=function*(){let n=yield function(e){return new Promise(((t,r)=>{let n=_r.connect({host:e,port:8009,rejectUnauthorized:!1});n.on("secureConnect",(()=>{console.log(`Connected to chromecast at ${e}.`),t(n)})),n.on("close",(()=>{console.log(`Disconnected from chromecast at ${e}.`)})),n.on("error",(e=>{n.end()}))}))}(r);n.on("close",(()=>{vn.delete(r)}));let s=yield function(e){return new Promise(((r,n)=>{t.get(`http://${e}:8008/ssdp/device-desc.xml`,(e=>{let t=[];e.on("data",(e=>{t.push(e)})),e.on("end",(()=>{let e=Buffer.concat(t).toString(),n=/<friendlyName>([^<]+)<\/friendlyName>/.exec(e);St(n)?r(n[1]):r(void 0)})),e.on("error",(()=>{n()}))}))}))}(r);new kn(n,null!=s?s:"Chromecast",e)},new((i=void 0)||(i=Promise))((function(e,t){function r(e){try{l(o.next(e))}catch(e){t(e)}}function a(e){try{l(o.throw(e))}catch(e){t(e)}}function l(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(r,a)}l((o=o.apply(n,s||[])).next())}));var n,s,i,o}))}((e,t)=>{let r=Pr[e];void 0===r&&(r=new Array,Pr[e]=r),r.push((e=>{if(!vn.has(e)){vn.add(e);for(let t of _n)try{t(e)}catch(e){}}})),(e=>{let t=Buffer.alloc(12);t.writeUInt16BE(1,4);let r=Buffer.alloc(1e3),n=0;e.split(".").forEach((e=>{if(e.length>=64)throw new Error;r.writeUInt8(e.length,n),n+=1,r.write(e,n),n+=e.length})),r.writeUInt8(0,n),n+=1,r.writeUInt16BE(12,n),n+=2,r.writeUInt16BE(1,n),n+=2,r=r.slice(0,0+n),$r.send(Buffer.concat([t,r]),5353,qr)})(e)})("_googlecast._tcp.local");class On{constructor(e,t){this.socket=e,this.requestId=1,function(e,t){let r=Buffer.alloc(0),n=!0,s=4;e.on("data",(e=>{for(r=Buffer.concat([r,e]);r.length>=s;){let e=r.slice(0,s);r=r.slice(s),n?(n=!1,s=e.readUInt32BE(0)):(n=!0,s=4,t(e))}}))}(e,(e=>{try{let r=function(e){let t=function(e){let t=new Array;for(;e.offset<e.buffer.length;){let r=Ir(e);t.push(r)}return t}({buffer:e,offset:0});return{protocol_version:kr(1,t),source_id:xr(2,t),destination_id:xr(3,t),namespace:xr(4,t),payload_type:kr(5,t),payload_utf8:function(e,t){try{return xr(6,t)}catch(e){return}}(0,t),payload_binary:function(e,t){try{return function(e,t){let r=t.filter((e=>7===e.key.field_number));if(0===r.length)throw"Expected required field to be present!";return r[r.length-1].data}(0,t)}catch(e){return}}(0,t)}}(e);t(r)}catch(e){console.log(e)}}))}getRequestId(){return Math.floor(65536*Math.random())}send(e){var t,r,n,s;let i=function(e){return Buffer.concat([Rr(1,e.protocol_version),Ur(2,e.source_id),Ur(3,e.destination_id),Ur(4,e.namespace),Rr(5,e.payload_type),(6,t=e.payload_utf8,null==t?Buffer.alloc(0):Ur(6,t)),Ar(7,e.payload_binary)]);var t}({protocol_version:null!==(t=e.protocol_version)&&void 0!==t?t:Sr.CASTV2_1_0,source_id:null!==(r=e.source_id)&&void 0!==r?r:"sender-0",destination_id:null!==(n=e.destination_id)&&void 0!==n?n:"receiver-0",namespace:e.namespace,payload_type:null!==(s=e.payload_type)&&void 0!==s?s:vr.STRING,payload_utf8:e.payload_utf8,payload_binary:e.payload_binary}),o=Buffer.alloc(4);o.writeUInt32BE(i.length,0),this.socket.write(o),this.socket.write(i)}}class En{constructor(e){this.messageHandler=e,this.serializer=new a.m7.MessageSerializer(zr),this.listeners=new cr.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),n=a.l8.String.as(r.type);this.serializer.deserialize(JSON.stringify({type:n,data:r}),((e,t)=>{this.listeners.route(e,t)}))}send(e,t,r){this.messageHandler.send({namespace:En.NAMESPACE,destination_id:r,payload_utf8:JSON.stringify(t)})}}En.NAMESPACE="urn:x-cast:com.google.cast.tp.connection";class Tn{constructor(e){this.messageHandler=e,this.serializer=new a.m7.MessageSerializer(Jr),this.listeners=new cr.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),n=a.l8.String.as(r.type);this.serializer.deserialize(JSON.stringify({type:n,data:r}),((e,t)=>{this.listeners.route(e,t)}))}send(e,t){this.messageHandler.send({namespace:Tn.NAMESPACE,payload_utf8:JSON.stringify(t)})}}Tn.NAMESPACE="urn:x-cast:com.google.cast.tp.heartbeat";class jn{constructor(e){this.transportId=new Tt(void 0),this.mediaSessionId=new Tt(void 0),this.messageHandler=e,this.serializer=new a.m7.MessageSerializer(gn),this.callbacks=new Map,this.requestId=1,this.listeners=new cr.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),n=a.l8.String.as(r.type);try{this.serializer.deserialize(JSON.stringify({type:n,data:r}),((e,t)=>{let r=this.callbacks.get(t.requestId);St(r)&&(this.callbacks.delete(t.requestId),r(t)),this.listeners.route(e,t)}))}catch(e){console.log(JSON.stringify(r,null,2))}}send(e,t,r){t.requestId=this.messageHandler.getRequestId(),St(r)&&this.callbacks.set(t.requestId,r),this.messageHandler.send({namespace:jn.NAMESPACE,destination_id:this.transportId.getState(),payload_utf8:JSON.stringify(t)})}}jn.NAMESPACE="urn:x-cast:com.google.cast.media";class In{constructor(e){this.messageHandler=e,this.serializer=new a.m7.MessageSerializer(mn),this.callbacks=new Map,this.requestId=1,this.listeners=new cr.routing.MessageRouter}handle(e){var t;let r=JSON.parse(null!==(t=e.payload_utf8)&&void 0!==t?t:"{}"),n=a.l8.String.as(r.type);this.serializer.deserialize(JSON.stringify({type:n,data:r}),((e,t)=>{let r=this.callbacks.get(t.requestId);St(r)&&(this.callbacks.delete(t.requestId),r(t)),this.listeners.route(e,t)}))}send(e,t,r){t.requestId=this.messageHandler.getRequestId(),St(r)&&this.callbacks.set(t.requestId,r),this.messageHandler.send({namespace:In.NAMESPACE,payload_utf8:JSON.stringify(t)})}}In.NAMESPACE="urn:x-cast:com.google.cast.receiver";const Nn="CC1AD845";class kn{constructor(e,t,r){let n=new On(e,(e=>{let t=e.namespace;t===En.NAMESPACE?this.connectionHandler.handle(e):t===Tn.NAMESPACE?this.heartbeatHandler.handle(e):t===jn.NAMESPACE?this.mediaHandler.handle(e):t===In.NAMESPACE&&this.receiverHandler.handle(e)}));this.socket=e,this.heartbeatHandler=new Tn(n),this.connectionHandler=new En(n),this.mediaHandler=new jn(n),this.receiverHandler=new In(n);let s=`${r?"wss:":"ws:"}//127.0.0.1/sockets/context/?type=chromecast&name=${t}`;this.context=new pr(s,(e=>new hr.yU(e))),this.timer=void 0,e.on("close",(()=>{St(this.timer)&&clearTimeout(this.timer),this.context.close()})),this.connectionHandler.send("CONNECT",{type:"CONNECT"}),this.connectionHandler.listeners.addObserver("CLOSE",(e=>{this.mediaHandler.transportId.updateState(void 0)})),this.heartbeatHandler.listeners.addObserver("PING",(e=>{this.heartbeatHandler.send("PONG",{type:"PONG"})})),this.heartbeatHandler.listeners.addObserver("PONG",(e=>{this.setTimer()})),this.receiverHandler.listeners.addObserver("RECEIVER_STATUS",(e=>{var t;let r=(null!==(t=e.status.applications)&&void 0!==t?t:[]).find((e=>e.appId===Nn));St(r)?this.mediaHandler.transportId.updateState(r.transportId):this.mediaHandler.transportId.updateState(void 0)})),this.mediaHandler.listeners.addObserver("MEDIA_STATUS",(e=>{let t=e.status[e.status.length-1];if(St(t)){let e=this.mediaHandler.mediaSessionId.getState();St(e)&&(t.mediaSessionId===e?this.context.isDeviceLocal.getState()&&"IDLE"===t.playerState&&"FINISHED"===t.idleReason&&this.context.next():this.mediaHandler.mediaSessionId.updateState(void 0))}})),this.setTimer(),this.mediaHandler.transportId.addObserver((e=>{St(e)&&this.connectionHandler.send("CONNECT",{type:"CONNECT"},e)})),this.context.isDeviceLocal.addObserver((e=>{if(e)yt(this.mediaHandler.transportId.getState())&&this.receiverHandler.send("LAUNCH",{type:"LAUNCH",requestId:-1,appId:Nn});else{let e=this.mediaHandler.mediaSessionId.getState();St(e)&&this.mediaHandler.send("STOP",{type:"STOP",requestId:-1,mediaSessionId:e})}}));{let e=()=>{let e=this.mediaHandler.transportId.getState(),t=this.context.currentLocalEntry.getState(),r=this.context.token.getState();if(St(e)&&St(t)&&St(r)){let e,n=function(e,t){let r=`${yn}/files/${e.file.file_id}/?token=${t}`;if(Wt.is(e)){let n=e,s=n.season.show;return{contentId:r,contentType:e.file.mime,streamType:"BUFFERED",metadata:{metadataType:0,title:n.title,subtitle:s.title},tracks:n.subtitles.map(((e,r)=>Object.assign(Object.assign({},Sn(e.language)),{trackId:r,type:"TEXT",trackType:"TEXT",trackContentId:`${yn}/files/${e.file_id}/?token=${t}`,trackContentType:e.mime,subtype:"SUBTITLES"})))}}if(Gt.is(e)){let n=e;return{contentId:r,contentType:e.file.mime,streamType:"BUFFERED",metadata:{metadataType:0,title:n.title,images:yt(n.artwork)?void 0:[{url:`${yn}/files/${n.artwork.file_id}/?token=${t}`}]},tracks:n.subtitles.map(((e,r)=>Object.assign(Object.assign({},Sn(e.language)),{trackId:r,type:"TEXT",trackType:"TEXT",trackContentId:`${yn}/files/${e.file_id}/?token=${t}`,trackContentType:e.mime,subtype:"SUBTITLES"})))}}if(Ct.is(e)){let n=e,s=n.disc.album;return{contentId:r,contentType:e.file.mime,streamType:"BUFFERED",metadata:{metadataType:0,title:n.title,subtitle:n.artists.map((e=>e.title)).join(" • "),images:yt(s.artwork)?void 0:[{url:`${yn}/files/${s.artwork.file_id}/?token=${t}`}]}}}throw"Expected code to be unreachable!"}(t,r);if(St(n.tracks)){let t=n.tracks.find((e=>"sv-SE"===e.language));if(St(t))e=[t.trackId];else{let t=n.tracks.find((e=>"en-US"===e.language));if(St(t))e=[t.trackId];else{let t=n.tracks.find((e=>"ja-JP"===e.language));St(t)&&(e=[t.trackId])}}}this.mediaHandler.send("LOAD",{type:"LOAD",requestId:-1,media:n,autoplay:!1,activeTrackIds:e},(e=>{if(hn.is(e)){let t=e.status[e.status.length-1];St(t)&&this.mediaHandler.mediaSessionId.updateState(t.mediaSessionId)}}))}};this.mediaHandler.transportId.addObserver(e),this.context.currentLocalEntry.addObserver(e),this.context.token.addObserver(e)}this.mediaHandler.transportId.addObserver((e=>{yt(e)&&this.context.isDeviceLocal.getState()&&this.context.transfer(void 0)})),this.mediaHandler.transportId.addObserver((e=>{yt(e)&&this.mediaHandler.mediaSessionId.updateState(void 0)}));{let e=()=>{let e=this.mediaHandler.mediaSessionId.getState();St(e)&&(this.context.playback.getState()?this.mediaHandler.send("PLAY",{type:"PLAY",requestId:-1,mediaSessionId:e}):this.mediaHandler.send("PAUSE",{type:"PAUSE",requestId:-1,mediaSessionId:e}))};this.mediaHandler.mediaSessionId.addObserver(e),this.context.playback.addObserver(e)}{let e=()=>{var e;let t=this.mediaHandler.mediaSessionId.getState();if(St(t)){let r=null!==(e=this.context.progress.getState())&&void 0!==e?e:0;this.mediaHandler.send("SEEK",{type:"SEEK",requestId:-1,mediaSessionId:t,currentTime:r})}};this.mediaHandler.mediaSessionId.addObserver(e),this.context.progress.addObserver(e)}}setTimer(){St(this.timer)&&(clearTimeout(this.timer),this.timer=void 0),this.timer=setTimeout((()=>{this.timer=void 0,this.heartbeatHandler.send("PING",{type:"PING"}),this.timer=setTimeout((()=>{this.socket.destroy()}),5e3)}),5e3)}}const Rn=new class{constructor(){this.tokens=new Map,this.sessions=new Map,this.chromecasts=new Tt([]),this.tss=new gr(dr),this.tss.addEventListener("sys","connect",(e=>{console.log("connect: "+e.connection_url);let t=br(e.connection_id,e.connection_url);this.tss.send("SetLocalDevice",e.connection_id,{device:t}),"chromecast"===t.type&&this.chromecasts.updateState([...this.chromecasts.getState(),t])})),this.tss.addEventListener("sys","disconnect",(e=>{console.log("disconnect: "+e.connection_url);let t=br(e.connection_id,e.connection_url);this.revokeAuthentication(e.connection_id),"chromecast"===t.type&&this.chromecasts.updateState(this.chromecasts.getState().filter((e=>e.id!==t.id)))})),this.tss.addEventListener("app","SetToken",(e=>{this.revokeAuthentication(e.connection_id);let t=e.data.token;if(St(t)){let r=st(t);this.tokens.set(e.connection_id,t);let n=this.getSession(r),s=br(e.connection_id,e.connection_url);n.devices.updateState([...n.devices.getState(),s]),this.tss.send("SetContext",e.connection_id,{context:n.context}),this.tss.send("SetDevice",e.connection_id,{device:n.device}),this.tss.send("SetIndex",e.connection_id,{index:n.index}),this.tss.send("SetPlayback",e.connection_id,{playback:n.playback}),this.tss.send("SetProgress",e.connection_id,{progress:n.progress}),this.tss.send("SetToken",e.connection_id,{token:t})}})),this.tss.addEventListener("app","SetContext",(e=>{this.getExistingSession(e.connection_id,(t=>{yt(t.device)&&(t.device=br(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),t.index=void 0,this.tss.send("SetIndex",t.devices.getState().map((e=>e.id)),{index:t.index}),t.context=e.data.context,this.tss.send("SetContext",t.devices.getState().map((e=>e.id)),e.data)}))})),this.tss.addEventListener("app","SetDevice",(e=>{this.getExistingSession(e.connection_id,(t=>{this.updateProgress(t),this.tss.send("SetProgress",t.devices.getState().map((e=>e.id)),{progress:t.progress}),t.device=e.data.device,this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),e.data),St(t.device)&&this.tss.send("SetToken",t.device.id,{token:this.tokens.get(e.connection_id)})}))})),this.tss.addEventListener("app","SetIndex",(e=>{this.getExistingSession(e.connection_id,(t=>{yt(t.device)&&(t.device=br(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),t.progress=St(e.data.index)?0:void 0,t.progressTimestamp=Date.now(),this.tss.send("SetProgress",t.devices.getState().map((e=>e.id)),{progress:t.progress}),t.index=e.data.index,this.tss.send("SetIndex",t.devices.getState().map((e=>e.id)),e.data)}))})),this.tss.addEventListener("app","SetPlayback",(e=>{this.getExistingSession(e.connection_id,(t=>{yt(t.device)&&(t.device=br(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),this.updateProgress(t),t.playback=e.data.playback,this.tss.send("SetPlayback",t.devices.getState().map((e=>e.id)),e.data)}))})),this.tss.addEventListener("app","SetProgress",(e=>{this.getExistingSession(e.connection_id,(t=>{yt(t.device)&&(t.device=br(e.connection_id,e.connection_url),this.tss.send("SetDevice",t.devices.getState().map((e=>e.id)),{device:t.device})),t.progress=e.data.progress,t.progressTimestamp=Date.now(),this.tss.send("SetProgress",t.devices.getState().map((e=>e.id)),e.data)}))}))}getExistingSession(e,t){let r=this.tokens.get(e);if(St(r)){let e=st(r),n=this.sessions.get(e);St(n)&&t(n)}}getSession(e){let t=this.sessions.get(e);if(St(t))return t;const r={playback:!1,devices:new Tt(new Array)};let n=new Tt([]);{let e=()=>{let e=r.devices.getState(),t=this.chromecasts.getState().filter((t=>yt(e.find((e=>e.id===t.id)))));n.updateState([...e,...t])};r.devices.addObserver(e),this.chromecasts.addObserver(e)}return n.addObserver((e=>{this.tss.send("SetDevices",r.devices.getState().map((e=>e.id)),{devices:e})})),r.devices.addObserver((e=>{this.updateProgress(r)})),r.devices.addObserver((e=>{yt(e.find((e=>{var t;return e.id===(null===(t=r.device)||void 0===t?void 0:t.id)})))&&(this.updateProgress(r),r.playback=!1,this.tss.send("SetPlayback",e.map((e=>e.id)),{playback:r.playback}),r.device=void 0,this.tss.send("SetDevice",e.map((e=>e.id)),{device:r.device}))})),this.sessions.set(e,r),r}revokeAuthentication(e){let t=this.tokens.get(e);if(this.tokens.delete(e),St(t)){let r=st(t),n=this.sessions.get(r);if(St(n)){let t=n.devices;t.updateState(t.getState().filter((t=>t.id!==e)))}}}updateProgress(e){let t=Date.now();e.playback&&St(e.progress)&&St(e.progressTimestamp)&&(e.progress+=(t-e.progressTimestamp)/1e3),e.progressTimestamp=t}getRequestHandler(){return this.tss.getRequestHandler()}};function xn(t,r){t.headers.host;let n=t.method||"",o=t.url||"";if(/^[/]sockets[/]/.test(o))return Rn.getRequestHandler()(t,r);let a,l=Date.now();if(r.on("finish",(()=>{let e=Date.now()-l;process.stderr.write(`${("    "+e).slice(-4)}ms ${n}:${o}\n`)})),"GET"===n&&"/favicon.ico"===o)return r.writeHead(404),void r.end();if("GET"===n&&null!==(a=/^[/]files[/]([0-9a-f]{32})[/]/.exec(o))){return((t,r,n)=>{if(void 0===r.url)throw new Error;let o="";try{var a=i.parse(r.url,!0);o=st(a.query.token)}catch(e){return n.writeHead(401,{}),n.end()}let l,d=oe[t],c=d.path,u=d.mime,f=c.join(s.sep),p=e.openSync(f,"r"),h=e.fstatSync(p).size;e.closeSync(p);let g=r.headers.range;if(void 0!==g&&null!=(l=/^bytes\=((?:[0-9])|(?:[1-9][0-9]+))\-((?:[0-9])|(?:[1-9][0-9]+))?$/.exec(g))){let r=parseInt(l[1]),s=l[2]?parseInt(l[2]):null;if(null===s&&(s=h-1),r>=h||s>=h||s<r)return n.writeHead(416),void n.end();let i=s-r+1;n.writeHead(206,{"Access-Control-Allow-Origin":"*","Accept-Ranges":"bytes","Cache-Control":"private, max-age=86400","Content-Range":`bytes ${r}-${s}/${h}`,"Content-Type":u,"Content-Length":""+i}),(m=e.createReadStream(f,{start:r,end:s})).addListener("close",(()=>{r+m.bytesRead===h&&function(t,r){let n=Date.now();G.streams.push({username:t,file_id:r,timestamp_ms:n}),we.insert(r,{file_id:r,username:t,timestamp_ms:n}),e.writeFileSync("./private/db/streams.json",JSON.stringify(G,null,"\t"))}(o,t)})),m.on("open",(function(){m.pipe(n)})),m.on("error",(function(e){n.end()}))}else{var m;(m=e.createReadStream(f)).on("open",(function(){n.writeHead(200,{"Access-Control-Allow-Origin":"*","Accept-Ranges":"bytes","Cache-Control":"private, max-age=86400","Content-Type":u,"Content-Length":""+h}),m.pipe(n)})),m.on("error",(function(e){n.writeHead(404),n.end()}))}})(a[1],t,r)}if(/^[/]media[/]/.test(o)){if(null!=(a=/^[/]media[/]stills[/]([0-9a-f]{32})[/]/.exec(o))){let t=a[1],n=oe[t],s=[".","private","stills",n.file_id];if(e.existsSync(s.join("/"))){let t=e.createReadStream(s.join("/"));t.on("open",(()=>{r.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/jpeg"}),t.pipe(r)}))}else((t,i)=>{var o,a,l,d;o=this,a=void 0,d=function*(){if(yield function(e,t){return new Promise(((r,n)=>{return s=this,i=void 0,a=function*(){let s=yield ut([".",...t.path],0),i=s[Math.floor(s.length/2)];wt(((s,o)=>{let a=[...s,"still.jpeg"],l=it.spawn("ffmpeg",["-ss",H(i),"-i",[".",...t.path].join("/"),"-vf","scale=w=960:h=540:force_original_aspect_ratio=decrease,pad=960:540:-1:-1","-map_metadata","-1",a.join("/"),"-y"]);l.on("error",(()=>(Et(s.join("/")),n()))),l.on("exit",(()=>(Ot(a,e),Et(s.join("/")),r())))}))},new((o=void 0)||(o=Promise))((function(e,t){function r(e){try{l(a.next(e))}catch(e){t(e)}}function n(e){try{l(a.throw(e))}catch(e){t(e)}}function l(t){var s;t.done?e(t.value):(s=t.value,s instanceof o?s:new o((function(e){e(s)}))).then(r,n)}l((a=a.apply(s,i||[])).next())}));var s,i,o,a}))}(s,n),!e.existsSync(s.join("/")))return r.writeHead(500),r.end();let t=e.createReadStream(s.join("/"));t.on("open",(()=>{r.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/jpeg"}),t.pipe(r)}))},new((l=void 0)||(l=Promise))((function(e,t){function r(e){try{s(d.next(e))}catch(e){t(e)}}function n(e){try{s(d.throw(e))}catch(e){t(e)}}function s(t){var s;t.done?e(t.value):(s=t.value,s instanceof l?s:new l((function(e){e(s)}))).then(r,n)}s((d=d.apply(o,a||[])).next())}))})();return}if(null!=(a=/^[/]media[/]gifs[/]([0-9a-f]{32})[/]/.exec(o))){let t=a[1],n=ie[t],s=[".","private","memes",n.cue_id];if(e.existsSync(s.join("/"))){let t=e.createReadStream(s.join("/"));t.on("open",(()=>{r.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/gif"}),t.pipe(r)}))}else!function(e,t,r){let n=$.video.subtitles.find((e=>e.subtitle_id===t.subtitle_id)),s=$.files.find((e=>e.file_id===n.file_id));const i=function(e){return oe[e.video_file_id]||null}(n);if(null==i)return r();wt(((n,o)=>{let a=[...n,"subtitle.vtt"],l=[...n,"palette.png"],d=[...n,"meme.gif"],c=it.spawn("ffmpeg",["-ss",H(t.start_ms),"-t",H(Math.min(t.duration_ms,5e3)),"-i",[".",...s.path].join("/"),a.join("/"),"-y"]);c.on("error",(()=>(console.log("ffmpeg command failed!"),Et(n.join("/")),r()))),c.on("exit",(()=>{it.spawn("ffmpeg",["-ss",H(t.start_ms),"-t",H(Math.min(t.duration_ms,5e3)),"-i",[".",...i.path].join("/"),"-vf","fps=15,scale=w=384:h=216:force_original_aspect_ratio=decrease,pad=384:216:-1:-1,subtitles="+a.join("/")+":force_style='Bold=1,Fontsize=24,Outline=2',palettegen",l.join("/"),"-y"]).on("exit",(()=>{it.spawn("ffmpeg",["-ss",H(t.start_ms),"-t",H(Math.min(t.duration_ms,5e3)),"-i",[".",...i.path].join("/"),"-i",l.join("/"),"-filter_complex","fps=15,scale=w=384:h=216:force_original_aspect_ratio=decrease,pad=384:216:-1:-1,subtitles="+a.join("/")+":force_style='Bold=1,Fontsize=24,Outline=2'[x];[x][1:v]paletteuse","-map_metadata","-1",d.join("/"),"-y"]).on("exit",(()=>(Ot(d,e),Et(n.join("/")),r())))}))}))}))}(s,n,(()=>{if(!e.existsSync(s.join("/")))return r.writeHead(500),r.end();let t=e.createReadStream(s.join("/"));t.on("open",(()=>{r.writeHead(200,{"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=86400","Content-Type":"image/gif"}),t.pipe(r)}))}));return}if(/^[/]media[/]channels[/]/.test(o))return void function(e,t,r){const n=t.method||"GET",s=t.url||"/";let i=null;"GET"===n&&null!=(i=/^[/]media[/]channels[/]([0-9]+)[/]([0-9]+)[/]([0-9]+)_([0-9a-f]+)[_]([0-9]+)(?:[_]([0-9]+)?)[.]ts/.exec(s))?(()=>{ft(this,void 0,void 0,(function*(){Number.parseInt(i[1]),Number.parseInt(i[2]),Number.parseInt(i[3]);const e=i[4],n=Number.parseInt(i[5]),s=i[6]?Number.parseInt(i[6]):null;let o=oe[e];if(!o)throw"Expected a valid file id!";const a=it.spawn("ffmpeg",["-hide_banner","-ss",""+n/1e3,...null!=s?["-t",""+(s-80)/1e3]:[],"-i",o.path.join("/"),"-c","copy","-f","mpegts","-muxdelay","0","-avoid_negative_ts","disabled","-output_ts_offset","0","-copyts","pipe:"]);let l=t.headers.connection||"close";r.writeHead(200,{Connection:l}),a.stdout.pipe(r)}))})():"GET"===n&&null!=(i=/^[/]media[/]channels[/]([0-9]+)[/]([0-9]+)[/]/.exec(s))?(()=>{ft(this,void 0,void 0,(function*(){const n=Number.parseInt(i[1]),s=(Number.parseInt(i[2]),Date.now()),o=function(e){return gt(e).map((e=>{let t=Ne(e.file_id),r=t.duration,n=e.start_time_ms+t.duration;return Object.assign(Object.assign({},e),{duration_ms:r,end_time_ms:n})}))}(n);let a=0;for(;a<o.length;a++){let e=o[a];if(e.start_time_ms<=s&&s<e.end_time_ms)break}let l=o[a],d=yield bt(l.file_id),c=0;for(;;){let e=d[c];if(l.start_time_ms+e.offset_ms+e.duration_ms>=s)break;c+=1}let u=c;const f=new Array;let p=0,h=0;for(;p<6&&h<3e4;){c>=d.length&&(f.push(""),f.push("#EXT-X-DISCONTINUITY"),a+=1,c=0,l=o[a],d=yield bt(l.file_id));let t=d[c];f.push(""),f.push("#EXT-X-PROGRAM-DATE-TIME:"+new Date(l.start_time_ms+t.offset_ms).toISOString()),f.push(`#EXTINF:${(t.duration_ms/1e3).toFixed(3)},`),f.push(`${c}_${l.file_id}_${t.offset_ms}_${t.duration_ms}.ts?token=${e}`),c+=1,p+=1,h+=t.duration_ms}let g=["#EXTM3U","#EXT-X-VERSION:3","#EXT-X-TARGETDURATION:10","#EXT-X-DISCONTINUITY-SEQUENCE:"+a,"#EXT-X-MEDIA-SEQUENCE:"+u,...f].join("\n"),m=t.headers.connection||"close";r.writeHead(200,{Connection:m}),r.end(g)}))})():(r.writeHead(404),r.end())}(i.parse(t.url||"/",!0).query.token,t,r)}return/^[/]api[/]/.test(o)?((e,t)=>{try{_t.route(e,t)}catch(e){t.writeHead(500),t.end(JSON.stringify({error:e.message}))}})(t,r):"GET"===n?(r.writeHead(200),void r.end(`<!doctype html><html><head><base href="/"/><meta charset="utf-8"/><meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0" name="viewport"/><link href="https://fonts.googleapis.com/css2?family=Nunito&family=Pacifico&family=Space+Mono&display=swap" rel="stylesheet"/><title>Orbit</title></head><body><script>${e.readFileSync("./dist/client.js")}<\/script></body></html>`)):(console.log("unhandled",JSON.stringify(t.headers,null,"\t")),r.writeHead(400),void r.end())}function Un(t){if(e.existsSync(t))return e.readFileSync(t)}e.existsSync("./private/certs/")||e.mkdirSync("./private/certs/",{recursive:!0});let An=Un("./private/certs/full_chain.pem"),Cn=Un("./private/certs/dhparam.pem"),Ln=Un("./private/certs/certificate_key.pem");if(An&&Ln){let e=n.createServer({cert:An,dhparam:Cn,key:Ln},xn);e.listen(443,(()=>{console.log("https://localhost:443")})),e.keepAliveTimeout=6e4,t.createServer({},((e,t)=>{let r=e.headers.host||"",n=e.url||"",s=r.split(":").shift();t.writeHead(307,{Location:"https://"+s+":443"+n}),t.end()})).listen(80,(()=>{console.log("http://localhost:80")})),wn(!0)}else{let e=t.createServer({},xn);e.listen(80,(()=>{console.log("http://localhost:80")})),e.keepAliveTimeout=6e4,wn(!1)}})()})();